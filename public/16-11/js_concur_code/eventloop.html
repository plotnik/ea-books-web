<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.5">
<title>JavaScript Concurrency</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Remove comment around @import statement below when using as a custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
[hidden],template{display:none}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
input[type="search"]{-webkit-appearance:textfield;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}
input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*:before,*:after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.spread{width:100%}
p.lead,.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{font-size:1.21875em;line-height:1.6}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol,ul.no-bullet,ol.no-bullet{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.no-bullet{list-style:none}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite:before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media only screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7;font-weight:bold}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix:before,.clearfix:after,.float-group:before,.float-group:after{content:" ";display:table}
.clearfix:after,.float-group:after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
*:not(pre)>code.nobreak{word-wrap:normal}
*:not(pre)>code.nowrap{white-space:nowrap}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menu{color:rgba(0,0,0,.8)}
b.button:before,b.button:after{position:relative;top:-1px;font-weight:400}
b.button:before{content:"[";padding:0 3px 0 2px}
b.button:after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header:before,#header:after,#content:before,#content:after,#footnotes:before,#footnotes:after,#footer:before,#footer:after{content:" ";display:table}
#header:after,#content:after,#footnotes:after,#footer:after{clear:both}
#content{margin-top:1.25em}
#content:before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span:before{content:"\00a0\2013\00a0"}
#header .details br+span.author:before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark:before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber:after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media only screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}
@media only screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
.sect1{padding-bottom:.625em}
@media only screen and (min-width:768px){.sect1{padding-bottom:1.25em}}
.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor:before,h2>a.anchor:before,h3>a.anchor:before,#toctitle>a.anchor:before,.sidebarblock>.content>.title>a.anchor:before,h4>a.anchor:before,h5>a.anchor:before,h6>a.anchor:before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock>caption.title{white-space:nowrap;overflow:visible;max-width:0}
.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>.paragraph:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media only screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media only screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]:before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]:before{display:block}
.listingblock.terminal pre .command:before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt]):before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote:before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote:before{display:none}
.verseblock{margin:0 1em 1.25em 1em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 0 1.25em 0;display:block}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{text-align:left;word-spacing:0}
.quoteblock.abstract blockquote:before,.quoteblock.abstract blockquote p:first-of-type:before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
table.tableblock td>.paragraph:last-child p>p:last-child,table.tableblock th>p:last-child,table.tableblock td>p:last-child{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all th.tableblock,table.grid-all td.tableblock{border-width:0 1px 1px 0}
table.grid-all tfoot>tr>th.tableblock,table.grid-all tfoot>tr>td.tableblock{border-width:1px 1px 0 0}
table.grid-cols th.tableblock,table.grid-cols td.tableblock{border-width:0 1px 0 0}
table.grid-all *>tr>.tableblock:last-child,table.grid-cols *>tr>.tableblock:last-child{border-right-width:0}
table.grid-rows th.tableblock,table.grid-rows td.tableblock{border-width:0 0 1px 0}
table.grid-all tbody>tr:last-child>th.tableblock,table.grid-all tbody>tr:last-child>td.tableblock,table.grid-all thead:last-child>tr>th.tableblock,table.grid-rows tbody>tr:last-child>th.tableblock,table.grid-rows tbody>tr:last-child>td.tableblock,table.grid-rows thead:last-child>tr>th.tableblock{border-bottom-width:0}
table.grid-rows tfoot>tr>th.tableblock,table.grid-rows tfoot>tr>td.tableblock{border-width:1px 0 0 0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot{border-width:1px 0}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.unstyled,ol.unnumbered,ul.checklist,ul.none{list-style-type:none}
ul.unstyled,ol.unnumbered,ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1em;font-size:.85em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{width:1em;position:relative;top:1px}
ul.inline{margin:0 auto .625em auto;margin-left:-1.375em;margin-right:0;padding:0;list-style:none;overflow:hidden}
ul.inline>li{list-style:none;float:left;margin-left:1.375em;display:block}
ul.inline>li>*{display:block}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist>table tr>td:first-of-type{padding:0 .75em;line-height:1}
.colist>table tr>td:last-of-type{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em 0;border-width:1px 0 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;text-indent:-1.05em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note:before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip:before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning:before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution:before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important:before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]:after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@media print{@page{margin:1.25cm .75cm}
*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare):after,a[href^="https:"]:not(.bare):after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]:after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
.sect1{padding-bottom:0!important}
.sect1+.sect1{border:0!important}
#header>h1:first-child{margin-top:1.25rem}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em 0}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span:before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]:before{display:block}
#footer{background:none!important;padding:0 .9375em}
#footer-text{color:rgba(0,0,0,.6)!important;font-size:.9em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">
<style>
.listingblock .pygments .hll { background-color: #ffffcc }
.listingblock .pygments, .listingblock .pygments code { background: #ffffff; }
.listingblock .pygments .tok-c { color: #999988; font-style: italic } /* Comment */
.listingblock .pygments .tok-err { color: #a61717; background-color: #e3d2d2 } /* Error */
.listingblock .pygments .tok-k { font-weight: bold } /* Keyword */
.listingblock .pygments .tok-o { font-weight: bold } /* Operator */
.listingblock .pygments .tok-ch { color: #999988; font-style: italic } /* Comment.Hashbang */
.listingblock .pygments .tok-cm { color: #999988; font-style: italic } /* Comment.Multiline */
.listingblock .pygments .tok-cp { color: #999999; font-weight: bold } /* Comment.Preproc */
.listingblock .pygments .tok-cpf { color: #999988; font-style: italic } /* Comment.PreprocFile */
.listingblock .pygments .tok-c1 { color: #999988; font-style: italic } /* Comment.Single */
.listingblock .pygments .tok-cs { color: #999999; font-weight: bold; font-style: italic } /* Comment.Special */
.listingblock .pygments .tok-gd { color: #000000; background-color: #ffdddd } /* Generic.Deleted */
.listingblock .pygments .tok-ge { font-style: italic } /* Generic.Emph */
.listingblock .pygments .tok-gr { color: #aa0000 } /* Generic.Error */
.listingblock .pygments .tok-gh { color: #999999 } /* Generic.Heading */
.listingblock .pygments .tok-gi { color: #000000; background-color: #ddffdd } /* Generic.Inserted */
.listingblock .pygments .tok-go { color: #888888 } /* Generic.Output */
.listingblock .pygments .tok-gp { color: #555555 } /* Generic.Prompt */
.listingblock .pygments .tok-gs { font-weight: bold } /* Generic.Strong */
.listingblock .pygments .tok-gu { color: #aaaaaa } /* Generic.Subheading */
.listingblock .pygments .tok-gt { color: #aa0000 } /* Generic.Traceback */
.listingblock .pygments .tok-kc { font-weight: bold } /* Keyword.Constant */
.listingblock .pygments .tok-kd { font-weight: bold } /* Keyword.Declaration */
.listingblock .pygments .tok-kn { font-weight: bold } /* Keyword.Namespace */
.listingblock .pygments .tok-kp { font-weight: bold } /* Keyword.Pseudo */
.listingblock .pygments .tok-kr { font-weight: bold } /* Keyword.Reserved */
.listingblock .pygments .tok-kt { color: #445588; font-weight: bold } /* Keyword.Type */
.listingblock .pygments .tok-m { color: #009999 } /* Literal.Number */
.listingblock .pygments .tok-s { color: #bb8844 } /* Literal.String */
.listingblock .pygments .tok-na { color: #008080 } /* Name.Attribute */
.listingblock .pygments .tok-nb { color: #999999 } /* Name.Builtin */
.listingblock .pygments .tok-nc { color: #445588; font-weight: bold } /* Name.Class */
.listingblock .pygments .tok-no { color: #008080 } /* Name.Constant */
.listingblock .pygments .tok-ni { color: #800080 } /* Name.Entity */
.listingblock .pygments .tok-ne { color: #990000; font-weight: bold } /* Name.Exception */
.listingblock .pygments .tok-nf { color: #990000; font-weight: bold } /* Name.Function */
.listingblock .pygments .tok-nn { color: #555555 } /* Name.Namespace */
.listingblock .pygments .tok-nt { color: #000080 } /* Name.Tag */
.listingblock .pygments .tok-nv { color: #008080 } /* Name.Variable */
.listingblock .pygments .tok-ow { font-weight: bold } /* Operator.Word */
.listingblock .pygments .tok-w { color: #bbbbbb } /* Text.Whitespace */
.listingblock .pygments .tok-mb { color: #009999 } /* Literal.Number.Bin */
.listingblock .pygments .tok-mf { color: #009999 } /* Literal.Number.Float */
.listingblock .pygments .tok-mh { color: #009999 } /* Literal.Number.Hex */
.listingblock .pygments .tok-mi { color: #009999 } /* Literal.Number.Integer */
.listingblock .pygments .tok-mo { color: #009999 } /* Literal.Number.Oct */
.listingblock .pygments .tok-sa { color: #bb8844 } /* Literal.String.Affix */
.listingblock .pygments .tok-sb { color: #bb8844 } /* Literal.String.Backtick */
.listingblock .pygments .tok-sc { color: #bb8844 } /* Literal.String.Char */
.listingblock .pygments .tok-dl { color: #bb8844 } /* Literal.String.Delimiter */
.listingblock .pygments .tok-sd { color: #bb8844 } /* Literal.String.Doc */
.listingblock .pygments .tok-s2 { color: #bb8844 } /* Literal.String.Double */
.listingblock .pygments .tok-se { color: #bb8844 } /* Literal.String.Escape */
.listingblock .pygments .tok-sh { color: #bb8844 } /* Literal.String.Heredoc */
.listingblock .pygments .tok-si { color: #bb8844 } /* Literal.String.Interpol */
.listingblock .pygments .tok-sx { color: #bb8844 } /* Literal.String.Other */
.listingblock .pygments .tok-sr { color: #808000 } /* Literal.String.Regex */
.listingblock .pygments .tok-s1 { color: #bb8844 } /* Literal.String.Single */
.listingblock .pygments .tok-ss { color: #bb8844 } /* Literal.String.Symbol */
.listingblock .pygments .tok-bp { color: #999999 } /* Name.Builtin.Pseudo */
.listingblock .pygments .tok-fm { color: #990000; font-weight: bold } /* Name.Function.Magic */
.listingblock .pygments .tok-vc { color: #008080 } /* Name.Variable.Class */
.listingblock .pygments .tok-vg { color: #008080 } /* Name.Variable.Global */
.listingblock .pygments .tok-vi { color: #008080 } /* Name.Variable.Instance */
.listingblock .pygments .tok-vm { color: #008080 } /* Name.Variable.Magic */
.listingblock .pygments .tok-il { color: #009999 } /* Literal.Number.Integer.Long */
</style>
</head>
<body class="article toc2 toc-right">
<div id="header">
<h1>JavaScript Concurrency</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_1_why_javascript_concurrency">1. Why JavaScript Concurrency?</a>
<ul class="sectlevel2">
<li><a href="#_javascript_concurrency_principles">JavaScript concurrency principles</a>
<ul class="sectlevel3">
<li><a href="#_parallelize">Parallelize</a></li>
<li><a href="#_synchronize">Synchronize</a></li>
<li><a href="#_conserve">Conserve</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_2_the_javascript_execution_model">2. The JavaScript Execution Model</a>
<ul class="sectlevel2">
<li><a href="#_everything_is_a_task">Everything is a task</a>
<ul class="sectlevel3">
<li><a href="#_meet_the_players">Meet the players</a></li>
</ul>
</li>
<li><a href="#_execution_contexts">Execution contexts</a>
<ul class="sectlevel3">
<li><a href="#_job_queues">Job queues</a></li>
</ul>
</li>
<li><a href="#_creating_tasks_using_timers">Creating tasks using timers</a>
<ul class="sectlevel3">
<li><a href="#_using_settimeout">Using setTimeout()</a></li>
<li><a href="#_using_setinterval">Using setInterval()</a></li>
</ul>
</li>
<li><a href="#_responding_to_dom_events">Responding to DOM events</a>
<ul class="sectlevel3">
<li><a href="#_event_targets">Event targets</a></li>
<li><a href="#_managing_event_frequency">Managing event frequency</a></li>
</ul>
</li>
<li><a href="#_responding_to_network_events">Responding to network events</a>
<ul class="sectlevel3">
<li><a href="#_making_requests">Making requests</a></li>
<li><a href="#_coordinating_requests">Coordinating requests</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_3_synchronizing_with_promises">3. Synchronizing with Promises</a>
<ul class="sectlevel2">
<li><a href="#_resolving_and_rejecting_promises">Resolving and rejecting promises</a>
<ul class="sectlevel3">
<li><a href="#_resolving_promises">Resolving promises</a></li>
<li><a href="#_rejecting_promises">Rejecting promises</a></li>
<li><a href="#_empty_promises">Empty promises</a></li>
</ul>
</li>
<li><a href="#_reacting_to_promises">Reacting to promises</a>
<ul class="sectlevel3">
<li><a href="#_resolution_job_queues">Resolution job queues</a></li>
<li><a href="#_using_promised_data">Using promised data</a></li>
<li><a href="#_error_callbacks">Error callbacks</a></li>
<li><a href="#_always_reacting">Always reacting</a></li>
<li><a href="#_resolving_other_promises">Resolving other promises</a></li>
<li><a href="#_promise_like_objects">Promise–like objects</a></li>
</ul>
</li>
<li><a href="#_building_callback_chains">Building callback chains</a>
<ul class="sectlevel3">
<li><a href="#_promises_only_change_state_once">Promises only change state once</a></li>
<li><a href="#_immutable_promises">Immutable promises</a></li>
<li><a href="#_many_then_callbacks_many_promises">Many then callbacks, many promises</a></li>
<li><a href="#_passing_promises_around">Passing promises around</a></li>
</ul>
</li>
<li><a href="#_synchronizing_several_promises">Synchronizing several promises</a>
<ul class="sectlevel3">
<li><a href="#_waiting_on_promises">Waiting on promises</a></li>
<li><a href="#_cancelling_promises">Cancelling promises</a></li>
</ul>
</li>
<li><a href="#_promises_without_executors">Promises without executors</a></li>
</ul>
</li>
<li><a href="#_4_lazy_evaluation_with_generators">4. Lazy Evaluation with Generators</a>
<ul class="sectlevel2">
<li><a href="#_creating_generators_and_yielding_values">Creating generators and yielding values</a>
<ul class="sectlevel3">
<li><a href="#_generator_function_syntax">Generator function syntax</a></li>
<li><a href="#_yielding_values">Yielding values</a></li>
<li><a href="#_iterating_over_generators">Iterating over generators</a></li>
</ul>
</li>
<li><a href="#_infinite_sequences">Infinite sequences</a>
<ul class="sectlevel3">
<li><a href="#_no_end_in_sight">No end in sight</a></li>
<li><a href="#_alternating_sequences">Alternating sequences</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_9_advanced_nodejs_concurrency">9. Advanced NodeJS Concurrency</a>
<ul class="sectlevel2">
<li><a href="#_coroutines_with_co">Coroutines with Co</a>
<ul class="sectlevel3">
<li><a href="#_awaiting_values">Awaiting values</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="exampleblock">
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">Tutorial by Flavio Copes: The JavaScript Event Loop</dt>
<dd>
<p><a href="https://flaviocopes.com/javascript-event-loop/" class="bare">https://flaviocopes.com/javascript-event-loop/</a></p>
</dd>
<dt class="hdlist1">Truly understanding Async/Await</dt>
<dd>
<p><a href="https://medium.com/@rafaelvidaurre/truly-understanding-async-await-491dd580500e" class="bare">https://medium.com/@rafaelvidaurre/truly-understanding-async-await-491dd580500e</a></p>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_1_why_javascript_concurrency">1. Why JavaScript Concurrency?</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_javascript_concurrency_principles">JavaScript concurrency principles</h3>
<div class="sect3">
<h4 id="_parallelize">Parallelize</h4>

</div>
<div class="sect3">
<h4 id="_synchronize">Synchronize</h4>

</div>
<div class="sect3">
<h4 id="_conserve">Conserve</h4>

</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_2_the_javascript_execution_model">2. The JavaScript Execution Model</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_everything_is_a_task">Everything is a task</h3>
<div class="sect3">
<h4 id="_meet_the_players">Meet the players</h4>
<div class="dlist">
<dl>
<dt class="hdlist1">Execution environment</dt>
<dd>
<p>This container gets created whenever a new web page is opened.</p>
</dd>
<dt class="hdlist1">JavaScript interpreter</dt>
<dd>
<p>This is the component that&#8217;s responsible for parsing and executing our JavaScript source code. It&#8217;s the browser&#8217;s job to augment the interpreter with globals, such as <code>window</code>, and <code>XMLHttpRequest</code>.</p>
</dd>
<dt class="hdlist1">Task queue</dt>
<dd>
<p>Tasks are queued whenever something needs to happen. An execution environment has at least one of these queues, but typically, it has several of them</p>
</dd>
<dt class="hdlist1">Event loop</dt>
<dd>
<p>An execution environment has a single event loop that&#8217;s responsible for servicing all task queues. There&#8217;s only one event loop, because there&#8217;s only one thread.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_execution_contexts">Execution contexts</h3>
<div class="paragraph">
<p>There&#8217;s always an active JavaScript context, and within the interpreter, we&#8217;ll find
a stack of contexts.</p>
</div>
<div class="sect3">
<h4 id="_job_queues">Job queues</h4>
<div class="paragraph">
<p>The job queues within the JavaScript interpreter are actually much more straightforward than the task queues that are used to coordinate all the web browser components. There are only two essential queues. One is for creating new execution context stacks (call stacks). The other is specific to promise resolution callback functions.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_creating_tasks_using_timers">Creating tasks using timers</h3>
<div class="sect3">
<h4 id="_using_settimeout">Using setTimeout()</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js"><span class="tok-c1">// Be careful, this function hogs the CPU...</span>
<span class="tok-kd">function</span> <span class="tok-nx">expensive</span><span class="tok-p">(</span><span class="tok-nx">n</span> <span class="tok-o">=</span> <span class="tok-mi">25000</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-kd">var</span> <span class="tok-nx">i</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span>
  <span class="tok-k">while</span> <span class="tok-p">(</span><span class="tok-o">++</span><span class="tok-nx">i</span> <span class="tok-o">&lt;</span> <span class="tok-nx">n</span> <span class="tok-o">*</span> <span class="tok-nx">n</span><span class="tok-p">)</span> <span class="tok-p">{}</span>
  <span class="tok-k">return</span> <span class="tok-nx">i</span><span class="tok-p">;</span>
<span class="tok-p">}</span>

<span class="tok-c1">// Creates a timer, the callback uses</span>
<span class="tok-c1">// &quot;console.timeEnd()&quot; to see how long we</span>
<span class="tok-c1">// really waited, compared to the 300MS</span>
<span class="tok-c1">// we were expecting.</span>
<span class="tok-kd">var</span> <span class="tok-nx">timer</span> <span class="tok-o">=</span> <span class="tok-nx">setTimeout</span><span class="tok-p">(()</span> <span class="tok-p">=&gt;</span> <span class="tok-p">{</span>
   <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">timeEnd</span><span class="tok-p">(</span><span class="tok-s1">&#39;setTimeout&#39;</span><span class="tok-p">);</span>
<span class="tok-p">},</span> <span class="tok-mi">300</span><span class="tok-p">);</span>

<span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">time</span><span class="tok-p">(</span><span class="tok-s1">&#39;setTimeout&#39;</span><span class="tok-p">);</span>

<span class="tok-c1">// This takes a number of seconds to</span>
<span class="tok-c1">// complete on most CPUs. All the while, a</span>
<span class="tok-c1">// task has been queued to run our callback</span>
<span class="tok-c1">// function. But the event loop can&#39;t get</span>
<span class="tok-c1">// to that task until &quot;expensive()&quot; completes.</span>
<span class="tok-nx">expensive</span><span class="tok-p">();</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_using_setinterval">Using setInterval()</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js"><span class="tok-c1">// A counter for keeping track of which</span>
<span class="tok-c1">// interval we&#39;re on.</span>
<span class="tok-kd">var</span> <span class="tok-nx">cnt</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span>

<span class="tok-c1">// Set up an interval timer. The callback will</span>
<span class="tok-c1">// log which interval scheduled the callback.</span>
<span class="tok-kd">var</span> <span class="tok-nx">timer</span> <span class="tok-o">=</span> <span class="tok-nx">setInterval</span><span class="tok-p">(()</span> <span class="tok-p">=&gt;</span> <span class="tok-p">{</span>
   <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s1">&#39;Interval&#39;</span><span class="tok-p">,</span> <span class="tok-o">++</span><span class="tok-nx">cnt</span><span class="tok-p">);</span>
<span class="tok-p">},</span> <span class="tok-mi">3000</span><span class="tok-p">);</span>

<span class="tok-c1">// Block the CPU for a while. When we&#39;re no longer</span>
<span class="tok-c1">// blocking the CPU, the first interval is called,</span>
<span class="tok-c1">// as expected. Then the second, when expected. And</span>
<span class="tok-c1">// so on. So while we block the callback tasks, we&#39;re</span>
<span class="tok-c1">// also blocking tasks that schedule the next interval.</span>
<span class="tok-nx">expensive</span><span class="tok-p">(</span><span class="tok-mi">50000</span><span class="tok-p">);</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_responding_to_dom_events">Responding to DOM events</h3>
<div class="sect3">
<h4 id="_event_targets">Event targets</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js"><span class="tok-c1">// A generic event callback, logs the event timestamp.</span>
<span class="tok-kd">function</span> <span class="tok-nx">onClick</span><span class="tok-p">(</span><span class="tok-nx">e</span><span class="tok-p">)</span> <span class="tok-p">{</span>
   <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s1">&#39;click&#39;</span><span class="tok-p">,</span> <span class="tok-k">new</span> <span class="tok-nb">Date</span><span class="tok-p">(</span><span class="tok-nx">e</span><span class="tok-p">.</span><span class="tok-nx">timeStamp</span><span class="tok-p">));</span>
<span class="tok-p">}</span>

<span class="tok-c1">// The element we&#39;re going to use as the event</span>
<span class="tok-c1">// target.</span>
<span class="tok-kd">var</span> <span class="tok-nx">button</span> <span class="tok-o">=</span> <span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">querySelector</span><span class="tok-p">(</span><span class="tok-s1">&#39;button&#39;</span><span class="tok-p">);</span>

<span class="tok-c1">// Setup our &quot;onClick&quot; function as the</span>
<span class="tok-c1">// event listener for &quot;click&quot; events on this target.</span>
<span class="tok-nx">button</span><span class="tok-p">.</span><span class="tok-nx">addEventListener</span><span class="tok-p">(</span><span class="tok-s1">&#39;click&#39;</span><span class="tok-p">,</span> <span class="tok-nx">onClick</span><span class="tok-p">);</span>

<span class="tok-c1">// In addition to users clicking the button, the</span>
<span class="tok-c1">// EventTarget interface lets us manually dispatch</span>
<span class="tok-c1">// events.</span>
<span class="tok-nx">button</span><span class="tok-p">.</span><span class="tok-nx">dispatchEvent</span><span class="tok-p">(</span><span class="tok-k">new</span> <span class="tok-nx">Event</span><span class="tok-p">(</span><span class="tok-s1">&#39;click&#39;</span><span class="tok-p">));</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_managing_event_frequency">Managing event frequency</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js"><span class="tok-c1">// Keeps track of the number of &quot;mousemove&quot; events.</span>
<span class="tok-kd">var</span> <span class="tok-nx">events</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span>

<span class="tok-c1">// The &quot;debounce()&quot; takes the provided &quot;func&quot; an limits</span>
<span class="tok-c1">// the frequency at which it is called using &quot;limit&quot;</span>
<span class="tok-c1">// milliseconds.</span>
<span class="tok-kd">function</span> <span class="tok-nx">debounce</span><span class="tok-p">(</span><span class="tok-nx">func</span><span class="tok-p">,</span> <span class="tok-nx">limit</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-kd">var</span> <span class="tok-nx">timer</span><span class="tok-p">;</span>

    <span class="tok-k">return</span> <span class="tok-kd">function</span> <span class="tok-nx">debounced</span><span class="tok-p">(...</span><span class="tok-nx">args</span><span class="tok-p">)</span> <span class="tok-p">{</span>
       <span class="tok-c1">// Remove any existing timers.</span>
       <span class="tok-nx">clearTimeout</span><span class="tok-p">(</span><span class="tok-nx">timer</span><span class="tok-p">);</span>

       <span class="tok-c1">// Call the function after &quot;limit&quot; milliseconds.</span>
       <span class="tok-nx">timer</span> <span class="tok-o">=</span> <span class="tok-nx">setTimeout</span><span class="tok-p">(()</span> <span class="tok-p">=&gt;</span> <span class="tok-p">{</span>
         <span class="tok-nx">timer</span> <span class="tok-o">=</span> <span class="tok-kc">null</span><span class="tok-p">;</span>
         <span class="tok-nx">func</span><span class="tok-p">.</span><span class="tok-nx">apply</span><span class="tok-p">(</span><span class="tok-k">this</span><span class="tok-p">,</span> <span class="tok-nx">args</span><span class="tok-p">);</span>
       <span class="tok-p">},</span> <span class="tok-nx">limit</span><span class="tok-p">);</span>
    <span class="tok-p">};</span>
<span class="tok-p">}</span>

<span class="tok-c1">// Log what&#39;s being typed into the text input.</span>
<span class="tok-kd">function</span> <span class="tok-nx">onInput</span><span class="tok-p">(</span><span class="tok-nx">e</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s1">&#39;input&#39;</span><span class="tok-p">,</span> <span class="tok-nx">e</span><span class="tok-p">.</span><span class="tok-nx">target</span><span class="tok-p">.</span><span class="tok-nx">value</span><span class="tok-p">);</span>
<span class="tok-p">}</span>

<span class="tok-c1">// Listen to the &quot;mousemove&quot; event using the debounced</span>
<span class="tok-c1">// version of the &quot;onMouseMove()&quot; function. If we</span>
<span class="tok-c1">// didn&#39;t wrap this callback with &quot;debounce()&quot;</span>
<span class="tok-nb">window</span><span class="tok-p">.</span><span class="tok-nx">addEventListener</span><span class="tok-p">(</span><span class="tok-s1">&#39;mousemove&#39;</span><span class="tok-p">,</span> <span class="tok-nx">debounce</span><span class="tok-p">(</span><span class="tok-nx">onMouseMove</span><span class="tok-p">,</span> <span class="tok-mi">300</span><span class="tok-p">));</span>

<span class="tok-c1">// Listen to the &quot;input&quot; event using the debounced version</span>
<span class="tok-c1">// of the &quot;onInput()&quot; function to prevent triggering events</span>
<span class="tok-c1">// on every keystroke.</span>
<span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">querySelector</span><span class="tok-p">(</span><span class="tok-s1">&#39;input&#39;</span><span class="tok-p">)</span>
   <span class="tok-p">.</span><span class="tok-nx">addEventListener</span><span class="tok-p">(</span><span class="tok-s1">&#39;input&#39;</span><span class="tok-p">,</span> <span class="tok-nx">debounce</span><span class="tok-p">(</span><span class="tok-nx">onInput</span><span class="tok-p">,</span> <span class="tok-mi">250</span><span class="tok-p">));</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_responding_to_network_events">Responding to network events</h3>
<div class="sect3">
<h4 id="_making_requests">Making requests</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js"><span class="tok-c1">// Callback for successful network request,</span>
<span class="tok-c1">// parses JSON data.</span>
<span class="tok-kd">function</span> <span class="tok-nx">onLoad</span><span class="tok-p">(</span><span class="tok-nx">e</span><span class="tok-p">)</span> <span class="tok-p">{</span>
   <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s1">&#39;load&#39;</span><span class="tok-p">,</span> <span class="tok-nx">JSON</span><span class="tok-p">.</span><span class="tok-nx">parse</span><span class="tok-p">(</span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">responseText</span><span class="tok-p">));</span>
<span class="tok-p">}</span>

<span class="tok-c1">// Callback for problematic network request,</span>
<span class="tok-c1">// logs error.</span>
<span class="tok-kd">function</span> <span class="tok-nx">onError</span><span class="tok-p">()</span> <span class="tok-p">{</span>
   <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">error</span><span class="tok-p">(</span><span class="tok-s1">&#39;network&#39;</span><span class="tok-p">,</span> <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">statusText</span> <span class="tok-o">||</span> <span class="tok-s1">&#39;unknown error&#39;</span><span class="tok-p">);</span>
<span class="tok-p">}</span>

<span class="tok-c1">// Callback for a cancelled network request,</span>
<span class="tok-c1">// logs warning.</span>
<span class="tok-kd">function</span> <span class="tok-nx">onAbort</span><span class="tok-p">()</span> <span class="tok-p">{</span>
   <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">warn</span><span class="tok-p">(</span><span class="tok-s1">&#39;request aborted...&#39;</span><span class="tok-p">);</span>
<span class="tok-p">}</span>

<span class="tok-kd">var</span> <span class="tok-nx">request</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">XMLHttpRequest</span><span class="tok-p">();</span>

<span class="tok-c1">// Uses the &quot;EventTarget&quot; interface to attach event</span>
<span class="tok-c1">// listeners, for each of the potential conditions.</span>
<span class="tok-nx">request</span><span class="tok-p">.</span><span class="tok-nx">addEventListener</span><span class="tok-p">(</span><span class="tok-s1">&#39;load&#39;</span><span class="tok-p">,</span> <span class="tok-nx">onLoad</span><span class="tok-p">);</span>
<span class="tok-nx">request</span><span class="tok-p">.</span><span class="tok-nx">addEventListener</span><span class="tok-p">(</span><span class="tok-s1">&#39;error&#39;</span><span class="tok-p">,</span> <span class="tok-nx">onError</span><span class="tok-p">);</span>
<span class="tok-nx">request</span><span class="tok-p">.</span><span class="tok-nx">addEventListener</span><span class="tok-p">(</span><span class="tok-s1">&#39;abort&#39;</span><span class="tok-p">,</span> <span class="tok-nx">onAbort</span><span class="tok-p">);</span>

<span class="tok-c1">// Sends a &quot;GET&quot; request for &quot;api.json&quot;.</span>
<span class="tok-nx">request</span><span class="tok-p">.</span><span class="tok-nx">open</span><span class="tok-p">(</span><span class="tok-s1">&#39;get&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;api.json&#39;</span><span class="tok-p">);</span>
<span class="tok-nx">request</span><span class="tok-p">.</span><span class="tok-nx">send</span><span class="tok-p">();</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_coordinating_requests">Coordinating requests</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js"><span class="tok-c1">// The function that&#39;s called when a response arrives ,</span>
<span class="tok-c1">// it&#39;s also responsible for coordinating responses.</span>
<span class="tok-kd">function</span> <span class="tok-nx">onLoad</span><span class="tok-p">()</span> <span class="tok-p">{</span>

    <span class="tok-c1">// When the response is ready, we push the parsed</span>
    <span class="tok-c1">// response onto the &quot;responses&quot; array, so that we</span>
    <span class="tok-c1">// can use responses later on when the rest of them</span>
    <span class="tok-c1">// arrive.</span>
    <span class="tok-nx">responses</span><span class="tok-p">.</span><span class="tok-nx">push</span><span class="tok-p">(</span><span class="tok-nx">JSON</span><span class="tok-p">.</span><span class="tok-nx">parse</span><span class="tok-p">(</span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">responseText</span><span class="tok-p">));</span>

    <span class="tok-c1">// Have all the respected responses showed up yet?</span>
    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-nx">responses</span><span class="tok-p">.</span><span class="tok-nx">length</span> <span class="tok-o">===</span> <span class="tok-mi">3</span><span class="tok-p">)</span> <span class="tok-p">{</span>
        <span class="tok-c1">// How we can do whatever we need to, in order</span>
        <span class="tok-c1">// to render the UI component because we have</span>
        <span class="tok-c1">// all the data.</span>
        <span class="tok-k">for</span> <span class="tok-p">(</span><span class="tok-kd">let</span> <span class="tok-nx">response</span> <span class="tok-k">of</span> <span class="tok-nx">responses</span><span class="tok-p">)</span> <span class="tok-p">{</span>
            <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s1">&#39;hello&#39;</span><span class="tok-p">,</span> <span class="tok-nx">response</span><span class="tok-p">.</span><span class="tok-nx">hello</span><span class="tok-p">);</span>
        <span class="tok-p">}</span>
    <span class="tok-p">}</span>
<span class="tok-p">}</span>

<span class="tok-c1">// Creates our API request instances, and a &quot;responses&quot;</span>
<span class="tok-c1">// array used to hold out-of-sync responses.</span>
<span class="tok-kd">var</span> <span class="tok-nx">req1</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">XMLHttpRequest</span><span class="tok-p">(),</span>
    <span class="tok-nx">req2</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">XMLHttpRequest</span><span class="tok-p">(),</span>
    <span class="tok-nx">req3</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">XMLHttpRequest</span><span class="tok-p">(),</span>
    <span class="tok-nx">responses</span> <span class="tok-o">=</span> <span class="tok-p">[];</span>

<span class="tok-c1">// Issue network requests for all our network requests.</span>
<span class="tok-k">for</span> <span class="tok-p">(</span><span class="tok-kd">let</span> <span class="tok-nx">req</span> <span class="tok-k">of</span> <span class="tok-p">[</span> <span class="tok-nx">req1</span><span class="tok-p">,</span> <span class="tok-nx">req2</span><span class="tok-p">,</span> <span class="tok-nx">req3</span> <span class="tok-p">])</span> <span class="tok-p">{</span>
    <span class="tok-nx">req</span><span class="tok-p">.</span><span class="tok-nx">addEventListener</span><span class="tok-p">(</span><span class="tok-s1">&#39;load&#39;</span><span class="tok-p">,</span> <span class="tok-nx">onLoad</span><span class="tok-p">);</span>
    <span class="tok-nx">req</span><span class="tok-p">.</span><span class="tok-nx">open</span><span class="tok-p">(</span><span class="tok-s1">&#39;get&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;api.json&#39;</span><span class="tok-p">);</span>
    <span class="tok-nx">req</span><span class="tok-p">.</span><span class="tok-nx">send</span><span class="tok-p">();</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_3_synchronizing_with_promises">3. Synchronizing with Promises</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_resolving_and_rejecting_promises">Resolving and rejecting promises</h3>
<div class="sect3">
<h4 id="_resolving_promises">Resolving promises</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js"><span class="tok-c1">// The executor function used by our promise.</span>
<span class="tok-c1">// The first argument is the resolver function,</span>
<span class="tok-c1">// which is called in 1 second to resolve the promise.</span>
<span class="tok-kd">function</span> <span class="tok-nx">executor</span><span class="tok-p">(</span><span class="tok-nx">resolve</span><span class="tok-p">)</span> <span class="tok-p">{</span>
   <span class="tok-nx">setTimeout</span><span class="tok-p">(</span><span class="tok-nx">resolve</span><span class="tok-p">,</span> <span class="tok-mi">1000</span><span class="tok-p">);</span>
<span class="tok-p">}</span>

<span class="tok-c1">// The fulfillment callback for our promise. This</span>
<span class="tok-c1">// simply stopsthe fullfillment timer that was</span>
<span class="tok-c1">// started after our executor function was run.</span>
<span class="tok-kd">function</span> <span class="tok-nx">fulfilled</span><span class="tok-p">()</span> <span class="tok-p">{</span>
   <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">timeEnd</span><span class="tok-p">(</span><span class="tok-s1">&#39;fulfillment&#39;</span><span class="tok-p">);</span>
<span class="tok-p">}</span>

<span class="tok-c1">// Creates the promise, which will run the executor</span>
<span class="tok-c1">// function immediately. Then we start a timer to see</span>
<span class="tok-c1">// how long it takes for our fulfillment function to</span>
<span class="tok-c1">// be called.</span>
<span class="tok-kd">var</span> <span class="tok-nx">promise</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nb">Promise</span><span class="tok-p">(</span><span class="tok-nx">executor</span><span class="tok-p">);</span>
<span class="tok-nx">promise</span><span class="tok-p">.</span><span class="tok-nx">then</span><span class="tok-p">(</span><span class="tok-nx">fulfilled</span><span class="tok-p">);</span>
<span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">time</span><span class="tok-p">(</span><span class="tok-s1">&#39;fulfillment&#39;</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<hr>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js"><span class="tok-c1">// The executor function used by our promise.</span>
<span class="tok-c1">// Sets a timeout that calls &quot;resolve()&quot; one second</span>
<span class="tok-c1">// after the promise is created. It&#39;s resolving</span>
<span class="tok-c1">// a string value - &quot;done!&quot;.</span>
<span class="tok-kd">function</span> <span class="tok-nx">executor</span><span class="tok-p">(</span><span class="tok-nx">resolve</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-nx">setTimeout</span><span class="tok-p">(()</span> <span class="tok-p">=&gt;</span> <span class="tok-p">{</span>
        <span class="tok-nx">resolve</span><span class="tok-p">(</span><span class="tok-s1">&#39;done!&#39;</span><span class="tok-p">);</span>
    <span class="tok-p">},</span> <span class="tok-mi">1000</span><span class="tok-p">);</span>
<span class="tok-p">}</span>

<span class="tok-c1">// The fulfillment callback for our promise accepts</span>
<span class="tok-c1">// a value argument. This is the value that&#39;s passed</span>
<span class="tok-c1">// to the resolver.</span>
<span class="tok-kd">function</span> <span class="tok-nx">fulfilled</span><span class="tok-p">(</span><span class="tok-nx">value</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s1">&#39;resolved&#39;</span><span class="tok-p">,</span> <span class="tok-nx">value</span><span class="tok-p">);</span>
<span class="tok-p">}</span>

<span class="tok-c1">// Create our promise, providing the executor and</span>
<span class="tok-c1">// fulfillment function callbacks.</span>
<span class="tok-kd">var</span> <span class="tok-nx">promise</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nb">Promise</span><span class="tok-p">(</span><span class="tok-nx">executor</span><span class="tok-p">);</span>
<span class="tok-nx">promise</span><span class="tok-p">.</span><span class="tok-nx">then</span><span class="tok-p">(</span><span class="tok-nx">fulfilled</span><span class="tok-p">);</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_rejecting_promises">Rejecting promises</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js"><span class="tok-c1">// This executor function rejects the promise after</span>
<span class="tok-c1">// a timeout of one second. It uses the rejector function</span>
<span class="tok-c1">// to change the state, and to provide the rejected</span>
<span class="tok-c1">// callbacks with a value.</span>
<span class="tok-kd">function</span> <span class="tok-nx">executor</span><span class="tok-p">(</span><span class="tok-nx">resolve</span><span class="tok-p">,</span> <span class="tok-nx">reject</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-nx">setTimeout</span><span class="tok-p">(()</span> <span class="tok-p">=&gt;</span> <span class="tok-p">{</span>
        <span class="tok-nx">reject</span><span class="tok-p">(</span><span class="tok-s1">&#39;Failed&#39;</span><span class="tok-p">);</span>
    <span class="tok-p">},</span> <span class="tok-mi">1000</span><span class="tok-p">);</span>
<span class="tok-p">}</span>

<span class="tok-c1">// The function used as a rejected callback function. It</span>
<span class="tok-c1">// expects a reason for the rejection to be provided.</span>
<span class="tok-kd">function</span> <span class="tok-nx">rejected</span><span class="tok-p">(</span><span class="tok-nx">reason</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">error</span><span class="tok-p">(</span><span class="tok-nx">reason</span><span class="tok-p">);</span>
<span class="tok-p">}</span>

<span class="tok-c1">// Creates the promise, and runs the executor. Uses the</span>
<span class="tok-c1">// &quot;catch()&quot; method to assing the rejector callback function.</span>
<span class="tok-kd">var</span> <span class="tok-nx">promise</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nb">Promise</span><span class="tok-p">(</span><span class="tok-nx">executor</span><span class="tok-p">);</span>
<span class="tok-nx">promise</span><span class="tok-p">.</span><span class="tok-k">catch</span><span class="tok-p">(</span><span class="tok-nx">rejected</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<hr>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js"><span class="tok-c1">// This promise executor throws an error, and the rejected</span>
<span class="tok-c1">// callback function is called as a result.</span>
<span class="tok-k">new</span> <span class="tok-nb">Promise</span><span class="tok-p">(()</span> <span class="tok-p">=&gt;</span> <span class="tok-p">{</span>
    <span class="tok-k">throw</span> <span class="tok-k">new</span> <span class="tok-nb">Error</span><span class="tok-p">(</span><span class="tok-s1">&#39;Problem executing promise&#39;</span><span class="tok-p">);</span>
<span class="tok-p">}).</span><span class="tok-k">catch</span><span class="tok-p">((</span><span class="tok-nx">reason</span><span class="tok-p">)</span> <span class="tok-p">=&gt;</span> <span class="tok-p">{</span>
    <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">error</span><span class="tok-p">(</span><span class="tok-nx">reason</span><span class="tok-p">);</span>
<span class="tok-p">});</span>

<span class="tok-c1">// This promise executor catches an error, and rejects</span>
<span class="tok-c1">// the promise with a more useful message.</span>
<span class="tok-k">new</span> <span class="tok-nb">Promise</span><span class="tok-p">((</span><span class="tok-nx">resolve</span><span class="tok-p">,</span> <span class="tok-nx">reject</span><span class="tok-p">)</span> <span class="tok-p">=&gt;</span> <span class="tok-p">{</span>
    <span class="tok-k">try</span> <span class="tok-p">{</span>
        <span class="tok-kd">var</span> <span class="tok-nx">size</span> <span class="tok-o">=</span> <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">name</span><span class="tok-p">.</span><span class="tok-nx">length</span><span class="tok-p">;</span>
    <span class="tok-p">}</span> <span class="tok-k">catch</span><span class="tok-p">(</span><span class="tok-nx">error</span><span class="tok-p">)</span> <span class="tok-p">{</span>
        <span class="tok-nx">reject</span><span class="tok-p">(</span><span class="tok-nx">error</span> <span class="tok-k">instanceof</span> <span class="tok-nx">TypeError</span> <span class="tok-o">?</span> <span class="tok-s1">&#39;Missing &quot;name&quot; property&#39;</span> <span class="tok-o">:</span> <span class="tok-nx">error</span><span class="tok-p">);</span>
    <span class="tok-p">}</span>
<span class="tok-p">}).</span><span class="tok-k">catch</span><span class="tok-p">((</span><span class="tok-nx">reason</span><span class="tok-p">)</span> <span class="tok-p">=&gt;</span> <span class="tok-p">{</span>
    <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">error</span><span class="tok-p">(</span><span class="tok-nx">reason</span><span class="tok-p">);</span>
<span class="tok-p">});</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_empty_promises">Empty promises</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js"><span class="tok-c1">// This promise is able to run the executor</span>
<span class="tok-c1">// function without issue. The &quot;then()&quot; callback</span>
<span class="tok-c1">// is never executed.</span>
<span class="tok-k">new</span> <span class="tok-nb">Promise</span><span class="tok-p">(()</span> <span class="tok-p">=&gt;</span> <span class="tok-p">{</span>
    <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s1">&#39;executing promise&#39;</span><span class="tok-p">);</span>
<span class="tok-p">}).</span><span class="tok-nx">then</span><span class="tok-p">(()</span> <span class="tok-p">=&gt;</span> <span class="tok-p">{</span>
    <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s1">&#39;never called&#39;</span><span class="tok-p">);</span>
<span class="tok-p">});</span>

<span class="tok-c1">// At this point, we have no idea what&#39;s</span>
<span class="tok-c1">// wrong with the promise.</span>
<span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s1">&#39;finished executing, promise hangs&#39;</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<hr>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js"><span class="tok-c1">// A wrapper for promise executor functions, that</span>
<span class="tok-c1">// throws an error after the given timeout.</span>
<span class="tok-kd">function</span> <span class="tok-nx">executorWrapper</span><span class="tok-p">(</span><span class="tok-nx">func</span><span class="tok-p">,</span> <span class="tok-nx">timeout</span><span class="tok-p">)</span> <span class="tok-p">{</span>

    <span class="tok-c1">// This is the function that&#39;s actually called by the</span>
    <span class="tok-c1">// promise. It takes the resolver and rejector functions</span>
    <span class="tok-c1">// as arguments.</span>
    <span class="tok-k">return</span> <span class="tok-kd">function</span> <span class="tok-nx">executor</span><span class="tok-p">(</span><span class="tok-nx">resolve</span><span class="tok-p">,</span> <span class="tok-nx">reject</span><span class="tok-p">)</span> <span class="tok-p">{</span>
        <span class="tok-c1">// Setup our timer. When time runs out, we can</span>
        <span class="tok-c1">// reject the promise with a timeout message.</span>
        <span class="tok-kd">var</span> <span class="tok-nx">timer</span> <span class="tok-o">=</span> <span class="tok-nx">setTimeout</span><span class="tok-p">(()</span> <span class="tok-p">=&gt;</span> <span class="tok-p">{</span>
            <span class="tok-nx">reject</span><span class="tok-p">(</span><span class="tok-sb">`Promise timed out after </span><span class="tok-si">${</span><span class="tok-nx">timeout</span><span class="tok-si">}</span><span class="tok-sb">MS`</span><span class="tok-p">);</span>
        <span class="tok-p">},</span> <span class="tok-nx">timeout</span><span class="tok-p">);</span>

        <span class="tok-c1">// Call the original executor function that we&#39;re</span>
        <span class="tok-c1">// wrapping. We&#39;re actually wrapping the resolver</span>
        <span class="tok-c1">// and rejector functions as well, so that when the</span>
        <span class="tok-c1">// executor calls them, the timer is cleared.</span>
        <span class="tok-nx">func</span><span class="tok-p">((</span><span class="tok-nx">value</span><span class="tok-p">)</span> <span class="tok-p">=&gt;</span> <span class="tok-p">{</span>
            <span class="tok-nx">clearTimeout</span><span class="tok-p">(</span><span class="tok-nx">timer</span><span class="tok-p">);</span>
            <span class="tok-nx">resolve</span><span class="tok-p">(</span><span class="tok-nx">value</span><span class="tok-p">);</span>
        <span class="tok-p">},</span> <span class="tok-p">(</span><span class="tok-nx">value</span><span class="tok-p">)</span> <span class="tok-p">=&gt;</span> <span class="tok-p">{</span>
            <span class="tok-nx">clearTimeout</span><span class="tok-p">(</span><span class="tok-nx">timer</span><span class="tok-p">);</span>
            <span class="tok-nx">reject</span><span class="tok-p">(</span><span class="tok-nx">value</span><span class="tok-p">);</span>
        <span class="tok-p">});</span>
    <span class="tok-p">};</span>
<span class="tok-p">}</span>

<span class="tok-c1">// This promise executor times out, and a timeout</span>
<span class="tok-c1">// error message is passed to the rejected callback.</span>
<span class="tok-k">new</span> <span class="tok-nb">Promise</span><span class="tok-p">(</span><span class="tok-nx">executorWrapper</span><span class="tok-p">((</span><span class="tok-nx">resolve</span><span class="tok-p">,</span> <span class="tok-nx">reject</span><span class="tok-p">)</span> <span class="tok-p">=&gt;</span> <span class="tok-p">{</span>
    <span class="tok-nx">setTimeout</span><span class="tok-p">(()</span> <span class="tok-p">=&gt;</span> <span class="tok-p">{</span>
        <span class="tok-nx">resolve</span><span class="tok-p">(</span><span class="tok-s1">&#39;done&#39;</span><span class="tok-p">);</span>
    <span class="tok-p">},</span> <span class="tok-mi">2000</span><span class="tok-p">);</span>
<span class="tok-p">},</span> <span class="tok-mi">1000</span><span class="tok-p">)).</span><span class="tok-k">catch</span><span class="tok-p">((</span><span class="tok-nx">reason</span><span class="tok-p">)</span> <span class="tok-p">=&gt;</span> <span class="tok-p">{</span>
    <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">error</span><span class="tok-p">(</span><span class="tok-nx">reason</span><span class="tok-p">);</span>
<span class="tok-p">});</span>

<span class="tok-c1">// This promise resolves as expected, since the executor</span>
<span class="tok-c1">// calls &quot;resolve()&quot; before time&#39;s up.</span>
<span class="tok-k">new</span> <span class="tok-nb">Promise</span><span class="tok-p">(</span><span class="tok-nx">executorWrapper</span><span class="tok-p">((</span><span class="tok-nx">resolve</span><span class="tok-p">,</span> <span class="tok-nx">reject</span><span class="tok-p">)</span> <span class="tok-p">=&gt;</span> <span class="tok-p">{</span>
    <span class="tok-nx">setTimeout</span><span class="tok-p">(()</span> <span class="tok-p">=&gt;</span> <span class="tok-p">{</span>
        <span class="tok-nx">resolve</span><span class="tok-p">(</span><span class="tok-kc">true</span><span class="tok-p">);</span>
    <span class="tok-p">},</span> <span class="tok-mi">500</span><span class="tok-p">);</span>
<span class="tok-p">},</span> <span class="tok-mi">1000</span><span class="tok-p">)).</span><span class="tok-nx">then</span><span class="tok-p">((</span><span class="tok-nx">value</span><span class="tok-p">)</span> <span class="tok-p">=&gt;</span> <span class="tok-p">{</span>
    <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s1">&#39;resolved&#39;</span><span class="tok-p">,</span> <span class="tok-nx">value</span><span class="tok-p">);</span>
<span class="tok-p">});</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_reacting_to_promises">Reacting to promises</h3>
<div class="sect3">
<h4 id="_resolution_job_queues">Resolution job queues</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js"><span class="tok-c1">// Creates 5 promises that log when they&#39;re</span>
<span class="tok-c1">// executing, and when they&#39;re reacting to a</span>
<span class="tok-c1">// resolved value.</span>
<span class="tok-k">for</span> <span class="tok-p">(</span><span class="tok-kd">let</span> <span class="tok-nx">i</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span> <span class="tok-nx">i</span> <span class="tok-o">&lt;</span> <span class="tok-mi">5</span><span class="tok-p">;</span> <span class="tok-nx">i</span><span class="tok-o">++</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-k">new</span> <span class="tok-nb">Promise</span><span class="tok-p">((</span><span class="tok-nx">resolve</span><span class="tok-p">)</span> <span class="tok-p">=&gt;</span> <span class="tok-p">{</span>
        <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s1">&#39;executing promise&#39;</span><span class="tok-p">);</span>
        <span class="tok-nx">resolve</span><span class="tok-p">(</span><span class="tok-nx">i</span><span class="tok-p">);</span>
    <span class="tok-p">}).</span><span class="tok-nx">then</span><span class="tok-p">((</span><span class="tok-nx">value</span><span class="tok-p">)</span> <span class="tok-p">=&gt;</span> <span class="tok-p">{</span>
        <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s1">&#39;resolved&#39;</span><span class="tok-p">,</span> <span class="tok-nx">i</span><span class="tok-p">);</span>
    <span class="tok-p">});</span>
<span class="tok-p">}</span>

<span class="tok-c1">// This is called before any of the fulfilled</span>
<span class="tok-c1">// callbacks, because this call stack job needs</span>
<span class="tok-c1">// to complete before the interpreter reaches into</span>
<span class="tok-c1">// the promise resolution callback queue, where</span>
<span class="tok-c1">// the 5 &quot;then()&quot; callbacks are currently sitting.</span>
<span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s1">&#39;done executing&#39;</span><span class="tok-p">);</span>

<span class="tok-c1">// →</span>
<span class="tok-c1">// executing promise</span>
<span class="tok-c1">// executing promise</span>
<span class="tok-c1">// ...</span>
<span class="tok-c1">// done executing</span>
<span class="tok-c1">// resolved 1</span>
<span class="tok-c1">// resolved 2</span>
<span class="tok-c1">// ...</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_using_promised_data">Using promised data</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js"><span class="tok-c1">// A generic function used to fetch resources</span>
<span class="tok-c1">// from the server, returns a promise.</span>
<span class="tok-kd">function</span> <span class="tok-nx">get</span><span class="tok-p">(</span><span class="tok-nx">path</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-k">return</span> <span class="tok-k">new</span> <span class="tok-nb">Promise</span><span class="tok-p">((</span><span class="tok-nx">resolve</span><span class="tok-p">,</span> <span class="tok-nx">reject</span><span class="tok-p">)</span> <span class="tok-p">=&gt;</span> <span class="tok-p">{</span>
        <span class="tok-kd">var</span> <span class="tok-nx">request</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">XMLHttpRequest</span><span class="tok-p">();</span>

        <span class="tok-c1">// The promise is resolved with the parsed</span>
        <span class="tok-c1">// JSON data when the data is loaded.</span>
        <span class="tok-nx">request</span><span class="tok-p">.</span><span class="tok-nx">addEventListener</span><span class="tok-p">(</span><span class="tok-s1">&#39;load&#39;</span><span class="tok-p">,</span> <span class="tok-p">(</span><span class="tok-nx">e</span><span class="tok-p">)</span> <span class="tok-p">=&gt;</span> <span class="tok-p">{</span>
            <span class="tok-nx">resolve</span><span class="tok-p">(</span><span class="tok-nx">JSON</span><span class="tok-p">.</span><span class="tok-nx">parse</span><span class="tok-p">(</span><span class="tok-nx">e</span><span class="tok-p">.</span><span class="tok-nx">target</span><span class="tok-p">.</span><span class="tok-nx">responseText</span><span class="tok-p">));</span>
        <span class="tok-p">});</span>

        <span class="tok-c1">// When there&#39;s an error with the request, the</span>
        <span class="tok-c1">// promise is rejected with the appropriate reason.</span>
        <span class="tok-nx">request</span><span class="tok-p">.</span><span class="tok-nx">addEventListener</span><span class="tok-p">(</span><span class="tok-s1">&#39;error&#39;</span><span class="tok-p">,</span> <span class="tok-p">(</span><span class="tok-nx">e</span><span class="tok-p">)</span> <span class="tok-p">=&gt;</span> <span class="tok-p">{</span>
            <span class="tok-nx">reject</span><span class="tok-p">(</span><span class="tok-nx">e</span><span class="tok-p">.</span><span class="tok-nx">target</span><span class="tok-p">.</span><span class="tok-nx">statusText</span> <span class="tok-o">||</span> <span class="tok-s1">&#39;unknown error&#39;</span><span class="tok-p">);</span>
        <span class="tok-p">});</span>

        <span class="tok-c1">// If the request is aborted, we simply resolve the</span>
        <span class="tok-c1">// request.</span>
        <span class="tok-nx">request</span><span class="tok-p">.</span><span class="tok-nx">addEventListener</span><span class="tok-p">(</span><span class="tok-s1">&#39;abort&#39;</span><span class="tok-p">,</span> <span class="tok-nx">resolve</span><span class="tok-p">);</span>

        <span class="tok-nx">request</span><span class="tok-p">.</span><span class="tok-nx">open</span><span class="tok-p">(</span><span class="tok-s1">&#39;get&#39;</span><span class="tok-p">,</span> <span class="tok-nx">path</span><span class="tok-p">);</span>
        <span class="tok-nx">request</span><span class="tok-p">.</span><span class="tok-nx">send</span><span class="tok-p">();</span>
    <span class="tok-p">});</span>
<span class="tok-p">}</span>

<span class="tok-c1">// We can attach our &quot;then()&quot; handler directly</span>
<span class="tok-c1">// to &quot;get()&quot; since it returns a promise. The</span>
<span class="tok-c1">// value used here was a true asynchronous operation</span>
<span class="tok-c1">// that had to go fetch a remote value, and parse it,</span>
<span class="tok-c1">// before resolving it here.</span>
<span class="tok-nx">get</span><span class="tok-p">(</span><span class="tok-s1">&#39;api.json&#39;</span><span class="tok-p">).</span><span class="tok-nx">then</span><span class="tok-p">((</span><span class="tok-nx">value</span><span class="tok-p">)</span> <span class="tok-p">=&gt;</span> <span class="tok-p">{</span>
    <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s1">&#39;hello&#39;</span><span class="tok-p">,</span> <span class="tok-nx">value</span><span class="tok-p">.</span><span class="tok-nx">hello</span><span class="tok-p">);</span>
<span class="tok-p">});</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_error_callbacks">Error callbacks</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js"><span class="tok-c1">// This promise executor will randomly resolve</span>
<span class="tok-c1">// or reject the promise.</span>
<span class="tok-kd">function</span> <span class="tok-nx">executor</span><span class="tok-p">(</span><span class="tok-nx">resolve</span><span class="tok-p">,</span> <span class="tok-nx">reject</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-nx">cnt</span><span class="tok-o">++</span><span class="tok-p">;</span>
    <span class="tok-nb">Math</span><span class="tok-p">.</span><span class="tok-nx">round</span><span class="tok-p">(</span><span class="tok-nb">Math</span><span class="tok-p">.</span><span class="tok-nx">random</span><span class="tok-p">())</span> <span class="tok-o">?</span>
        <span class="tok-nx">resolve</span><span class="tok-p">(</span><span class="tok-sb">`fulfilled promise </span><span class="tok-si">${</span><span class="tok-nx">cnt</span><span class="tok-si">}</span><span class="tok-sb">`</span><span class="tok-p">)</span> <span class="tok-o">:</span>
        <span class="tok-nx">reject</span><span class="tok-p">(</span><span class="tok-sb">`rejected promise </span><span class="tok-si">${</span><span class="tok-nx">cnt</span><span class="tok-si">}</span><span class="tok-sb">`</span><span class="tok-p">);</span>
<span class="tok-p">}</span>

<span class="tok-c1">// Make &quot;log()&quot; and &quot;error()&quot; functions for easy</span>
<span class="tok-c1">// callback functions.</span>
<span class="tok-kd">var</span> <span class="tok-nx">log</span> <span class="tok-o">=</span> <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">.</span><span class="tok-nx">bind</span><span class="tok-p">(</span><span class="tok-nx">console</span><span class="tok-p">),</span>
    <span class="tok-nx">error</span> <span class="tok-o">=</span> <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">error</span><span class="tok-p">.</span><span class="tok-nx">bind</span><span class="tok-p">(</span><span class="tok-nx">console</span><span class="tok-p">),</span>
    <span class="tok-nx">cnt</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span>

<span class="tok-c1">// Creates a promise, then assigns the error</span>
<span class="tok-c1">// callback via the &quot;catch()&quot; method.</span>
<span class="tok-k">new</span> <span class="tok-nb">Promise</span><span class="tok-p">(</span><span class="tok-nx">executor</span><span class="tok-p">).</span><span class="tok-nx">then</span><span class="tok-p">(</span><span class="tok-nx">log</span><span class="tok-p">).</span><span class="tok-k">catch</span><span class="tok-p">(</span><span class="tok-nx">error</span><span class="tok-p">);</span>

<span class="tok-c1">// Creates a promise, then assigns the error</span>
<span class="tok-c1">// callback via the &quot;then()&quot; method.</span>
<span class="tok-k">new</span> <span class="tok-nb">Promise</span><span class="tok-p">(</span><span class="tok-nx">executor</span><span class="tok-p">).</span><span class="tok-nx">then</span><span class="tok-p">(</span><span class="tok-nx">log</span><span class="tok-p">,</span> <span class="tok-nx">error</span><span class="tok-p">);</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_always_reacting">Always reacting</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js"><span class="tok-c1">// Extends the promise prototype with an &quot;always()&quot;</span>
<span class="tok-c1">// method. The given function will always be called,</span>
<span class="tok-c1">// whether the promise is fulfilled or rejected.</span>
<span class="tok-nb">Promise</span><span class="tok-p">.</span><span class="tok-nx">prototype</span><span class="tok-p">.</span><span class="tok-nx">always</span> <span class="tok-o">=</span> <span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">func</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-k">return</span> <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">then</span><span class="tok-p">(</span><span class="tok-nx">func</span><span class="tok-p">,</span> <span class="tok-nx">func</span><span class="tok-p">);</span>
<span class="tok-p">};</span>

<span class="tok-c1">// Creates a promise that&#39;s randomly resolved or</span>
<span class="tok-c1">// rejected.</span>
<span class="tok-kd">var</span> <span class="tok-nx">promise</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nb">Promise</span><span class="tok-p">((</span><span class="tok-nx">resolve</span><span class="tok-p">,</span> <span class="tok-nx">reject</span><span class="tok-p">)</span> <span class="tok-p">=&gt;</span> <span class="tok-p">{</span>
    <span class="tok-nb">Math</span><span class="tok-p">.</span><span class="tok-nx">round</span><span class="tok-p">(</span><span class="tok-nb">Math</span><span class="tok-p">.</span><span class="tok-nx">random</span><span class="tok-p">())</span> <span class="tok-o">?</span>
        <span class="tok-nx">resolve</span><span class="tok-p">(</span><span class="tok-s1">&#39;fulfilled&#39;</span><span class="tok-p">)</span> <span class="tok-o">:</span> <span class="tok-nx">reject</span><span class="tok-p">(</span><span class="tok-s1">&#39;rejected&#39;</span><span class="tok-p">);</span>
<span class="tok-p">});</span>

<span class="tok-c1">// Give the promise fulfillment and rejection callbacks.</span>
<span class="tok-nx">promise</span><span class="tok-p">.</span><span class="tok-nx">then</span><span class="tok-p">((</span><span class="tok-nx">value</span><span class="tok-p">)</span> <span class="tok-p">=&gt;</span> <span class="tok-p">{</span>
    <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-nx">value</span><span class="tok-p">);</span>
<span class="tok-p">},</span> <span class="tok-p">(</span><span class="tok-nx">reason</span><span class="tok-p">)</span> <span class="tok-p">=&gt;</span> <span class="tok-p">{</span>
    <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">error</span><span class="tok-p">(</span><span class="tok-nx">reason</span><span class="tok-p">);</span>
<span class="tok-p">});</span>

<span class="tok-c1">// This callback is always called after the one of</span>
<span class="tok-c1">// the callbacks above.</span>
<span class="tok-nx">promise</span><span class="tok-p">.</span><span class="tok-nx">always</span><span class="tok-p">((</span><span class="tok-nx">value</span><span class="tok-p">)</span> <span class="tok-p">=&gt;</span> <span class="tok-p">{</span>
    <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s1">&#39;cleaning up...&#39;</span><span class="tok-p">);</span>
<span class="tok-p">});</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_resolving_other_promises">Resolving other promises</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js"><span class="tok-c1">// Keeps a list of resolver functions.</span>
<span class="tok-kd">var</span> <span class="tok-nx">resolvers</span> <span class="tok-o">=</span> <span class="tok-p">[];</span>

<span class="tok-c1">// Creates 5 new promises, and in each executor</span>
<span class="tok-c1">// function, the resolver is pushed onto the</span>
<span class="tok-c1">// &quot;resolvers&quot; array. We also give each promise</span>
<span class="tok-c1">// a fulfillment callback.</span>
<span class="tok-k">for</span> <span class="tok-p">(</span><span class="tok-kd">let</span> <span class="tok-nx">i</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span> <span class="tok-nx">i</span> <span class="tok-o">&lt;</span> <span class="tok-mi">5</span><span class="tok-p">;</span> <span class="tok-nx">i</span><span class="tok-o">++</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-k">new</span> <span class="tok-nb">Promise</span><span class="tok-p">((</span><span class="tok-nx">resolve</span><span class="tok-p">)</span> <span class="tok-p">=&gt;</span> <span class="tok-p">{</span>
        <span class="tok-nx">resolvers</span><span class="tok-p">.</span><span class="tok-nx">push</span><span class="tok-p">(</span><span class="tok-nx">resolve</span><span class="tok-p">);</span>
    <span class="tok-p">}).</span><span class="tok-nx">then</span><span class="tok-p">((</span><span class="tok-nx">value</span><span class="tok-p">)</span> <span class="tok-p">=&gt;</span> <span class="tok-p">{</span>
        <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-sb">`resolved </span><span class="tok-si">${</span><span class="tok-nx">i</span> <span class="tok-o">+</span> <span class="tok-mi">1</span><span class="tok-si">}</span><span class="tok-sb">`</span><span class="tok-p">,</span> <span class="tok-nx">value</span><span class="tok-p">);</span>
    <span class="tok-p">});</span>
<span class="tok-p">}</span>

<span class="tok-c1">// Sets a timeout that runs the function after 2</span>
<span class="tok-c1">// seconds. When it runs, we iterate over every</span>
<span class="tok-c1">// resolver function in the &quot;resolvers&quot; array,</span>
<span class="tok-c1">// and we call it with a value.</span>
<span class="tok-nx">setTimeout</span><span class="tok-p">(()</span> <span class="tok-p">=&gt;</span> <span class="tok-p">{</span>
    <span class="tok-k">for</span> <span class="tok-p">(</span><span class="tok-kd">let</span> <span class="tok-nx">resolver</span> <span class="tok-k">of</span> <span class="tok-nx">resolvers</span><span class="tok-p">)</span> <span class="tok-p">{</span>
        <span class="tok-nx">resolver</span><span class="tok-p">(</span><span class="tok-kc">true</span><span class="tok-p">);</span>
    <span class="tok-p">}</span>
<span class="tok-p">},</span> <span class="tok-mi">2000</span><span class="tok-p">);</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_promise_like_objects">Promise–like objects</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js"><span class="tok-c1">// The &quot;Promise.resolve()&quot; method can resolve thenable</span>
<span class="tok-c1">// objects. This is an object with a &quot;then()&quot; method</span>
<span class="tok-c1">// which serves as the executor. This executor will</span>
<span class="tok-c1">// randomly resolve or reject the promise.</span>
<span class="tok-nb">Promise</span><span class="tok-p">.</span><span class="tok-nx">resolve</span><span class="tok-p">({</span> <span class="tok-nx">then</span><span class="tok-o">:</span> <span class="tok-p">(</span><span class="tok-nx">resolve</span><span class="tok-p">,</span> <span class="tok-nx">reject</span><span class="tok-p">)</span> <span class="tok-p">=&gt;</span> <span class="tok-p">{</span>
    <span class="tok-nb">Math</span><span class="tok-p">.</span><span class="tok-nx">round</span><span class="tok-p">(</span><span class="tok-nb">Math</span><span class="tok-p">.</span><span class="tok-nx">random</span><span class="tok-p">())</span> <span class="tok-o">?</span>
        <span class="tok-nx">resolve</span><span class="tok-p">(</span><span class="tok-s1">&#39;fulfilled&#39;</span><span class="tok-p">)</span> <span class="tok-o">:</span> <span class="tok-nx">reject</span><span class="tok-p">(</span><span class="tok-s1">&#39;rejected&#39;</span><span class="tok-p">);</span>

<span class="tok-c1">// This method returns a promise, so we&#39;re able</span>
<span class="tok-c1">// to setup our fulfilled and rejected callbacks as</span>
<span class="tok-c1">// usual.</span>
<span class="tok-p">}}).</span><span class="tok-nx">then</span><span class="tok-p">((</span><span class="tok-nx">value</span><span class="tok-p">)</span> <span class="tok-p">=&gt;</span> <span class="tok-p">{</span>
    <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s1">&#39;resolved&#39;</span><span class="tok-p">,</span> <span class="tok-nx">value</span><span class="tok-p">);</span>
<span class="tok-p">},</span> <span class="tok-p">(</span><span class="tok-nx">reason</span><span class="tok-p">)</span> <span class="tok-p">=&gt;</span> <span class="tok-p">{</span>
    <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">error</span><span class="tok-p">(</span><span class="tok-s1">&#39;reason&#39;</span><span class="tok-p">,</span> <span class="tok-nx">reason</span><span class="tok-p">);</span>
<span class="tok-p">});</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_building_callback_chains">Building callback chains</h3>
<div class="sect3">
<h4 id="_promises_only_change_state_once">Promises only change state once</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js"><span class="tok-c1">// This executor function attempts to resolve the</span>
<span class="tok-c1">// promise twice, but the fulfilled callback is</span>
<span class="tok-c1">// only called once.</span>
<span class="tok-k">new</span> <span class="tok-nb">Promise</span><span class="tok-p">((</span><span class="tok-nx">resolve</span><span class="tok-p">,</span> <span class="tok-nx">reject</span><span class="tok-p">)</span> <span class="tok-p">=&gt;</span> <span class="tok-p">{</span>
    <span class="tok-nx">resolve</span><span class="tok-p">(</span><span class="tok-s1">&#39;fulfilled&#39;</span><span class="tok-p">);</span>
    <span class="tok-nx">resolve</span><span class="tok-p">(</span><span class="tok-s1">&#39;fulfilled&#39;</span><span class="tok-p">);</span>
<span class="tok-p">}).</span><span class="tok-nx">then</span><span class="tok-p">((</span><span class="tok-nx">value</span><span class="tok-p">)</span> <span class="tok-p">=&gt;</span> <span class="tok-p">{</span>
    <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s1">&#39;then&#39;</span><span class="tok-p">,</span> <span class="tok-nx">value</span><span class="tok-p">);</span>
<span class="tok-p">});</span>

<span class="tok-c1">// This executor function attempts to reject the</span>
<span class="tok-c1">// promise twice, but the rejected callback is</span>
<span class="tok-c1">// only called once.</span>
<span class="tok-k">new</span> <span class="tok-nb">Promise</span><span class="tok-p">((</span><span class="tok-nx">resolve</span><span class="tok-p">,</span> <span class="tok-nx">reject</span><span class="tok-p">)</span> <span class="tok-p">=&gt;</span> <span class="tok-p">{</span>
    <span class="tok-nx">reject</span><span class="tok-p">(</span><span class="tok-s1">&#39;rejected&#39;</span><span class="tok-p">);</span>
    <span class="tok-nx">reject</span><span class="tok-p">(</span><span class="tok-s1">&#39;rejected&#39;</span><span class="tok-p">);</span>
<span class="tok-p">}).</span><span class="tok-k">catch</span><span class="tok-p">((</span><span class="tok-nx">reason</span><span class="tok-p">)</span> <span class="tok-p">=&gt;</span> <span class="tok-p">{</span>
    <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">error</span><span class="tok-p">(</span><span class="tok-s1">&#39;reason&#39;</span><span class="tok-p">);</span>
<span class="tok-p">});</span></code></pre>
</div>
</div>
<hr>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js"><span class="tok-c1">// This executor function resolves the promise immediately.</span>
<span class="tok-c1">// By the time the &quot;then()&quot; callback is added, the promise</span>
<span class="tok-c1">// is already resolved. But the callback is still called</span>
<span class="tok-c1">// with the resolved value.</span>
<span class="tok-k">new</span> <span class="tok-nb">Promise</span><span class="tok-p">((</span><span class="tok-nx">resolve</span><span class="tok-p">,</span> <span class="tok-nx">reject</span><span class="tok-p">)</span> <span class="tok-p">=&gt;</span> <span class="tok-p">{</span>
    <span class="tok-nx">resolve</span><span class="tok-p">(</span><span class="tok-s1">&#39;done&#39;</span><span class="tok-p">);</span>
    <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s1">&#39;executor&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;resolved&#39;</span><span class="tok-p">);</span>
<span class="tok-p">}).</span><span class="tok-nx">then</span><span class="tok-p">((</span><span class="tok-nx">value</span><span class="tok-p">)</span> <span class="tok-p">=&gt;</span> <span class="tok-p">{</span>
    <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s1">&#39;then&#39;</span><span class="tok-p">,</span> <span class="tok-nx">value</span><span class="tok-p">);</span>
<span class="tok-p">});</span>

<span class="tok-c1">// Creates a new promise that&#39;s resolved immediately by</span>
<span class="tok-c1">// the executor function.</span>
<span class="tok-kd">var</span> <span class="tok-nx">promise</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nb">Promise</span><span class="tok-p">((</span><span class="tok-nx">resolve</span><span class="tok-p">,</span> <span class="tok-nx">reject</span><span class="tok-p">)</span> <span class="tok-p">=&gt;</span> <span class="tok-p">{</span>
    <span class="tok-nx">resolve</span><span class="tok-p">(</span><span class="tok-s1">&#39;done&#39;</span><span class="tok-p">);</span>
    <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s1">&#39;executor&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;resolved&#39;</span><span class="tok-p">);</span>
<span class="tok-p">});</span>

<span class="tok-c1">// This callback is run immediately, since the promise</span>
<span class="tok-c1">// has already been resolved.</span>
<span class="tok-nx">promise</span><span class="tok-p">.</span><span class="tok-nx">then</span><span class="tok-p">((</span><span class="tok-nx">value</span><span class="tok-p">)</span> <span class="tok-p">=&gt;</span> <span class="tok-p">{</span>
    <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s1">&#39;then 1&#39;</span><span class="tok-p">,</span> <span class="tok-nx">value</span><span class="tok-p">);</span>
<span class="tok-p">});</span>

<span class="tok-c1">// This callback isn&#39;t added to the promise for another</span>
<span class="tok-c1">// second after it&#39;s been resolved. It&#39;s still called</span>
<span class="tok-c1">// right away with the resolved value.</span>
<span class="tok-nx">setTimeout</span><span class="tok-p">(()</span> <span class="tok-p">=&gt;</span> <span class="tok-p">{</span>
    <span class="tok-nx">promise</span><span class="tok-p">.</span><span class="tok-nx">then</span><span class="tok-p">((</span><span class="tok-nx">value</span><span class="tok-p">)</span> <span class="tok-p">=&gt;</span> <span class="tok-p">{</span>
        <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s1">&#39;then 2&#39;</span><span class="tok-p">,</span> <span class="tok-nx">value</span><span class="tok-p">);</span>
    <span class="tok-p">});</span>
<span class="tok-p">},</span> <span class="tok-mi">1000</span><span class="tok-p">);</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_immutable_promises">Immutable promises</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js"><span class="tok-c1">// Creates a promise that&#39;s resolved immediately, and</span>
<span class="tok-c1">// is stored in &quot;promise1&quot;.</span>
<span class="tok-kd">var</span> <span class="tok-nx">promise1</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nb">Promise</span><span class="tok-p">((</span><span class="tok-nx">resolve</span><span class="tok-p">,</span> <span class="tok-nx">reject</span><span class="tok-p">)</span> <span class="tok-p">=&gt;</span> <span class="tok-p">{</span>
    <span class="tok-nx">resolve</span><span class="tok-p">(</span><span class="tok-s1">&#39;fulfilled&#39;</span><span class="tok-p">);</span>
<span class="tok-p">});</span>

<span class="tok-c1">// Use the &quot;then()&quot; method of &quot;promise1&quot; to create a</span>
<span class="tok-c1">// new promise instance, which is stored in &quot;promise2&quot;.</span>
<span class="tok-kd">var</span> <span class="tok-nx">promise2</span> <span class="tok-o">=</span> <span class="tok-nx">promise1</span><span class="tok-p">.</span><span class="tok-nx">then</span><span class="tok-p">((</span><span class="tok-nx">value</span><span class="tok-p">)</span> <span class="tok-p">=&gt;</span> <span class="tok-p">{</span>
    <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s1">&#39;then 1&#39;</span><span class="tok-p">,</span> <span class="tok-nx">value</span><span class="tok-p">);</span>
    <span class="tok-c1">// → then 1 fulfilled</span>
<span class="tok-p">});</span>

<span class="tok-c1">// Create a &quot;then()&quot; callback for &quot;promise2&quot;. This actually</span>
<span class="tok-c1">// creates a third promise instance, but we don&#39;t do anything</span>
<span class="tok-c1">// with it.</span>
<span class="tok-nx">promise2</span><span class="tok-p">.</span><span class="tok-nx">then</span><span class="tok-p">((</span><span class="tok-nx">value</span><span class="tok-p">)</span> <span class="tok-p">=&gt;</span> <span class="tok-p">{</span>
    <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s1">&#39;then 2&#39;</span><span class="tok-p">,</span> <span class="tok-nx">value</span><span class="tok-p">);</span>
    <span class="tok-c1">// → then 2 undefined</span>
<span class="tok-p">});</span>

<span class="tok-c1">// Make sure that &quot;promise1&quot; and &quot;promise2&quot; are in fact</span>
<span class="tok-c1">// different objects.</span>
<span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s1">&#39;equal&#39;</span><span class="tok-p">,</span> <span class="tok-nx">promise1</span> <span class="tok-o">===</span> <span class="tok-nx">promise2</span><span class="tok-p">);</span>
<span class="tok-c1">// → equal false</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_many_then_callbacks_many_promises">Many then callbacks, many promises</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js"><span class="tok-c1">// Creates a new promise that&#39;s randomly resolved or</span>
<span class="tok-c1">// rejected.</span>
<span class="tok-k">new</span> <span class="tok-nb">Promise</span><span class="tok-p">((</span><span class="tok-nx">resolve</span><span class="tok-p">,</span> <span class="tok-nx">reject</span><span class="tok-p">)</span> <span class="tok-p">=&gt;</span> <span class="tok-p">{</span>
    <span class="tok-nb">Math</span><span class="tok-p">.</span><span class="tok-nx">round</span><span class="tok-p">(</span><span class="tok-nb">Math</span><span class="tok-p">.</span><span class="tok-nx">random</span><span class="tok-p">())</span> <span class="tok-o">?</span>
        <span class="tok-nx">resolve</span><span class="tok-p">(</span><span class="tok-s1">&#39;fulfilled&#39;</span><span class="tok-p">)</span> <span class="tok-o">:</span> <span class="tok-nx">reject</span><span class="tok-p">(</span><span class="tok-s1">&#39;rejected&#39;</span><span class="tok-p">);</span>
<span class="tok-p">}).</span><span class="tok-nx">then</span><span class="tok-p">((</span><span class="tok-nx">value</span><span class="tok-p">)</span> <span class="tok-p">=&gt;</span> <span class="tok-p">{</span>
    <span class="tok-c1">// Called when the original promise is resolved,</span>
    <span class="tok-c1">// returns the value in case there&#39;s another</span>
    <span class="tok-c1">// promise chained to this one.</span>
    <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s1">&#39;then 1&#39;</span><span class="tok-p">,</span> <span class="tok-nx">value</span><span class="tok-p">);</span>
    <span class="tok-k">return</span> <span class="tok-nx">value</span><span class="tok-p">;</span>
<span class="tok-p">}).</span><span class="tok-k">catch</span><span class="tok-p">((</span><span class="tok-nx">reason</span><span class="tok-p">)</span> <span class="tok-p">=&gt;</span> <span class="tok-p">{</span>
    <span class="tok-c1">// Chained to the second promise, called</span>
    <span class="tok-c1">// when it&#39;s rejected.</span>
    <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">error</span><span class="tok-p">(</span><span class="tok-s1">&#39;catch 1&#39;</span><span class="tok-p">,</span> <span class="tok-nx">reason</span><span class="tok-p">);</span>
<span class="tok-p">}).</span><span class="tok-nx">then</span><span class="tok-p">((</span><span class="tok-nx">value</span><span class="tok-p">)</span> <span class="tok-p">=&gt;</span> <span class="tok-p">{</span>
    <span class="tok-c1">// Chained to the third promise, gets the</span>
    <span class="tok-c1">// value as expected, and returns it for any</span>
    <span class="tok-c1">// downstream promise callbacks to consume.</span>
    <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s1">&#39;then 2&#39;</span><span class="tok-p">,</span> <span class="tok-nx">value</span><span class="tok-p">);</span>
    <span class="tok-k">return</span> <span class="tok-nx">value</span><span class="tok-p">;</span>
<span class="tok-p">}).</span><span class="tok-k">catch</span><span class="tok-p">((</span><span class="tok-nx">reason</span><span class="tok-p">)</span> <span class="tok-p">=&gt;</span> <span class="tok-p">{</span>
    <span class="tok-c1">// This is never called - rejections do not</span>
    <span class="tok-c1">// proliferate through promise chains.</span>
    <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">error</span><span class="tok-p">(</span><span class="tok-s1">&#39;catch 2&#39;</span><span class="tok-p">,</span> <span class="tok-nx">reason</span><span class="tok-p">)</span>
<span class="tok-p">});</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_passing_promises_around">Passing promises around</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js"><span class="tok-c1">// Simple utilty to compose a larger function, out</span>
<span class="tok-c1">// of smaller functions.</span>
<span class="tok-kd">function</span> <span class="tok-nx">compose</span><span class="tok-p">(...</span><span class="tok-nx">funcs</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-k">return</span> <span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">value</span><span class="tok-p">)</span> <span class="tok-p">{</span>
        <span class="tok-kd">var</span> <span class="tok-nx">result</span> <span class="tok-o">=</span> <span class="tok-nx">value</span><span class="tok-p">;</span>

        <span class="tok-k">for</span> <span class="tok-p">(</span><span class="tok-kd">let</span> <span class="tok-nx">func</span> <span class="tok-k">of</span> <span class="tok-nx">funcs</span><span class="tok-p">)</span> <span class="tok-p">{</span>
            <span class="tok-nx">result</span> <span class="tok-o">=</span> <span class="tok-nx">func</span><span class="tok-p">(</span><span class="tok-nx">value</span><span class="tok-p">);</span>
        <span class="tok-p">}</span>

        <span class="tok-k">return</span> <span class="tok-nx">result</span><span class="tok-p">;</span>
    <span class="tok-p">};</span>
<span class="tok-p">}</span>

<span class="tok-c1">// Accepts a promise or a resolved value. If it&#39;s a promise,</span>
<span class="tok-c1">// it adds a &quot;then()&quot; callback and returns a new promise.</span>
<span class="tok-c1">// Otherwise, it performs the &quot;update&quot; and returns the</span>
<span class="tok-c1">// value.</span>
<span class="tok-kd">function</span> <span class="tok-nx">updateFirstName</span><span class="tok-p">(</span><span class="tok-nx">value</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-nx">value</span> <span class="tok-k">instanceof</span> <span class="tok-nb">Promise</span><span class="tok-p">)</span> <span class="tok-p">{</span>
        <span class="tok-k">return</span> <span class="tok-nx">value</span><span class="tok-p">.</span><span class="tok-nx">then</span><span class="tok-p">(</span><span class="tok-nx">updateFirstName</span><span class="tok-p">);</span>
    <span class="tok-p">}</span>

    <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s1">&#39;first name&#39;</span><span class="tok-p">,</span> <span class="tok-nx">value</span><span class="tok-p">.</span><span class="tok-nx">first</span><span class="tok-p">);</span>
    <span class="tok-k">return</span> <span class="tok-nx">value</span><span class="tok-p">;</span>
<span class="tok-p">}</span>

<span class="tok-c1">// Works the same way as the above function, except it</span>
<span class="tok-c1">// performs a different UI &quot;update&quot;.</span>
<span class="tok-kd">function</span> <span class="tok-nx">updateLastName</span><span class="tok-p">(</span><span class="tok-nx">value</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-nx">value</span> <span class="tok-k">instanceof</span> <span class="tok-nb">Promise</span><span class="tok-p">)</span> <span class="tok-p">{</span>
        <span class="tok-k">return</span> <span class="tok-nx">value</span><span class="tok-p">.</span><span class="tok-nx">then</span><span class="tok-p">(</span><span class="tok-nx">updateLastName</span><span class="tok-p">);</span>
    <span class="tok-p">}</span>

    <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s1">&#39;last name&#39;</span><span class="tok-p">,</span> <span class="tok-nx">value</span><span class="tok-p">.</span><span class="tok-nx">last</span><span class="tok-p">);</span>
    <span class="tok-k">return</span> <span class="tok-nx">value</span><span class="tok-p">;</span>
<span class="tok-p">}</span>

<span class="tok-c1">// Works the same way as the above function, except it</span>
<span class="tok-c1">// performs a different UI &quot;update&quot;.</span>
<span class="tok-kd">function</span> <span class="tok-nx">updateAge</span><span class="tok-p">(</span><span class="tok-nx">value</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-nx">value</span> <span class="tok-k">instanceof</span> <span class="tok-nb">Promise</span><span class="tok-p">)</span> <span class="tok-p">{</span>
        <span class="tok-k">return</span> <span class="tok-nx">value</span><span class="tok-p">.</span><span class="tok-nx">then</span><span class="tok-p">(</span><span class="tok-nx">updateAge</span><span class="tok-p">);</span>
    <span class="tok-p">}</span>

    <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s1">&#39;age&#39;</span><span class="tok-p">,</span> <span class="tok-nx">value</span><span class="tok-p">.</span><span class="tok-nx">age</span><span class="tok-p">);</span>
    <span class="tok-k">return</span> <span class="tok-nx">value</span><span class="tok-p">;</span>
<span class="tok-p">}</span>

<span class="tok-c1">// A promise object that&#39;s resolved with a data object</span>
<span class="tok-c1">// after one second.</span>
<span class="tok-kd">var</span> <span class="tok-nx">promise</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nb">Promise</span><span class="tok-p">((</span><span class="tok-nx">resolve</span><span class="tok-p">,</span> <span class="tok-nx">reject</span><span class="tok-p">)</span> <span class="tok-p">=&gt;</span> <span class="tok-p">{</span>
    <span class="tok-nx">setTimeout</span><span class="tok-p">(()</span> <span class="tok-p">=&gt;</span> <span class="tok-p">{</span>
        <span class="tok-nx">resolve</span><span class="tok-p">({</span>
            <span class="tok-nx">first</span><span class="tok-o">:</span> <span class="tok-s1">&#39;John&#39;</span><span class="tok-p">,</span>
            <span class="tok-nx">last</span><span class="tok-o">:</span> <span class="tok-s1">&#39;Smith&#39;</span><span class="tok-p">,</span>
            <span class="tok-nx">age</span><span class="tok-o">:</span> <span class="tok-mi">37</span>
        <span class="tok-p">});</span>
    <span class="tok-p">},</span> <span class="tok-mi">1000</span><span class="tok-p">);</span>
<span class="tok-p">});</span>

<span class="tok-c1">// We compose an &quot;update()&quot; function that updates the</span>
<span class="tok-c1">// various UI components.</span>
<span class="tok-kd">var</span> <span class="tok-nx">update</span> <span class="tok-o">=</span> <span class="tok-nx">compose</span><span class="tok-p">(</span>
    <span class="tok-nx">updateFirstName</span><span class="tok-p">,</span>
    <span class="tok-nx">updateLastName</span><span class="tok-p">,</span>
    <span class="tok-nx">updateAge</span>
<span class="tok-p">);</span>

<span class="tok-c1">// Call our update function with a promise.</span>
<span class="tok-nx">update</span><span class="tok-p">(</span><span class="tok-nx">promise</span><span class="tok-p">);</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_synchronizing_several_promises">Synchronizing several promises</h3>
<div class="sect3">
<h4 id="_waiting_on_promises">Waiting on promises</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js"><span class="tok-c1">// Utility to send a &quot;GET&quot; HTTP request, and return</span>
<span class="tok-c1">// a promise that&#39;s resolved with the parsed response.</span>
<span class="tok-kd">function</span> <span class="tok-nx">get</span><span class="tok-p">(</span><span class="tok-nx">path</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-k">return</span> <span class="tok-k">new</span> <span class="tok-nb">Promise</span><span class="tok-p">((</span><span class="tok-nx">resolve</span><span class="tok-p">,</span> <span class="tok-nx">reject</span><span class="tok-p">)</span> <span class="tok-p">=&gt;</span> <span class="tok-p">{</span>
        <span class="tok-kd">var</span> <span class="tok-nx">request</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">XMLHttpRequest</span><span class="tok-p">();</span>

        <span class="tok-c1">// The promise is resolved with the parsed</span>
        <span class="tok-c1">// JSON data when the data is loaded.</span>
        <span class="tok-nx">request</span><span class="tok-p">.</span><span class="tok-nx">addEventListener</span><span class="tok-p">(</span><span class="tok-s1">&#39;load&#39;</span><span class="tok-p">,</span> <span class="tok-p">(</span><span class="tok-nx">e</span><span class="tok-p">)</span> <span class="tok-p">=&gt;</span> <span class="tok-p">{</span>
            <span class="tok-nx">resolve</span><span class="tok-p">(</span><span class="tok-nx">JSON</span><span class="tok-p">.</span><span class="tok-nx">parse</span><span class="tok-p">(</span><span class="tok-nx">e</span><span class="tok-p">.</span><span class="tok-nx">target</span><span class="tok-p">.</span><span class="tok-nx">responseText</span><span class="tok-p">));</span>
        <span class="tok-p">});</span>

        <span class="tok-c1">// When there&#39;s an error with the request, the</span>
        <span class="tok-c1">// promise is rejected with the appropriate reason.</span>
        <span class="tok-nx">request</span><span class="tok-p">.</span><span class="tok-nx">addEventListener</span><span class="tok-p">(</span><span class="tok-s1">&#39;error&#39;</span><span class="tok-p">,</span> <span class="tok-p">(</span><span class="tok-nx">e</span><span class="tok-p">)</span> <span class="tok-p">=&gt;</span> <span class="tok-p">{</span>
            <span class="tok-nx">reject</span><span class="tok-p">(</span><span class="tok-nx">e</span><span class="tok-p">.</span><span class="tok-nx">target</span><span class="tok-p">.</span><span class="tok-nx">statusText</span> <span class="tok-o">||</span> <span class="tok-s1">&#39;unknown error&#39;</span><span class="tok-p">);</span>
        <span class="tok-p">});</span>

        <span class="tok-c1">// If the request is aborted, we simply resolve the</span>
        <span class="tok-c1">// request.</span>
        <span class="tok-nx">request</span><span class="tok-p">.</span><span class="tok-nx">addEventListener</span><span class="tok-p">(</span><span class="tok-s1">&#39;abort&#39;</span><span class="tok-p">,</span> <span class="tok-nx">resolve</span><span class="tok-p">);</span>

        <span class="tok-nx">request</span><span class="tok-p">.</span><span class="tok-nx">open</span><span class="tok-p">(</span><span class="tok-s1">&#39;get&#39;</span><span class="tok-p">,</span> <span class="tok-nx">path</span><span class="tok-p">);</span>
        <span class="tok-nx">request</span><span class="tok-p">.</span><span class="tok-nx">send</span><span class="tok-p">();</span>
    <span class="tok-p">});</span>
<span class="tok-p">}</span>

<span class="tok-c1">// For our request promises.</span>
<span class="tok-kd">var</span> <span class="tok-nx">requests</span> <span class="tok-o">=</span> <span class="tok-p">[];</span>

<span class="tok-c1">// Issues 5 API requests, and places the 5 corresponding</span>
<span class="tok-c1">// promises in the &quot;requests&quot; array.</span>
<span class="tok-k">for</span> <span class="tok-p">(</span><span class="tok-kd">let</span> <span class="tok-nx">i</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span> <span class="tok-nx">i</span> <span class="tok-o">&lt;</span> <span class="tok-mi">5</span><span class="tok-p">;</span> <span class="tok-nx">i</span><span class="tok-o">++</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-nx">requests</span><span class="tok-p">.</span><span class="tok-nx">push</span><span class="tok-p">(</span><span class="tok-nx">get</span><span class="tok-p">(</span><span class="tok-s1">&#39;api.json&#39;</span><span class="tok-p">));</span>
<span class="tok-p">}</span>

<span class="tok-c1">// Using &quot;Promise.all()&quot; let&#39;s us pass in an array of</span>
<span class="tok-c1">// promises, returning a new promise that&#39;s resolved</span>
<span class="tok-c1">// when all promises resolve. Our callback gets an array</span>
<span class="tok-c1">// of resolved values that correspond to the promises.</span>
<span class="tok-nb">Promise</span><span class="tok-p">.</span><span class="tok-nx">all</span><span class="tok-p">(</span><span class="tok-nx">requests</span><span class="tok-p">).</span><span class="tok-nx">then</span><span class="tok-p">((</span><span class="tok-nx">values</span><span class="tok-p">)</span> <span class="tok-p">=&gt;</span> <span class="tok-p">{</span>
    <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s1">&#39;first&#39;</span><span class="tok-p">,</span> <span class="tok-nx">values</span><span class="tok-p">.</span><span class="tok-nx">map</span><span class="tok-p">(</span><span class="tok-nx">x</span> <span class="tok-p">=&gt;</span> <span class="tok-nx">x</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">]));</span>
    <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s1">&#39;second&#39;</span><span class="tok-p">,</span> <span class="tok-nx">values</span><span class="tok-p">.</span><span class="tok-nx">map</span><span class="tok-p">(</span><span class="tok-nx">x</span> <span class="tok-p">=&gt;</span> <span class="tok-nx">x</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">]));</span>
<span class="tok-p">});</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_cancelling_promises">Cancelling promises</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js"><span class="tok-c1">// The resolver function used to cancel data requests.</span>
<span class="tok-kd">var</span> <span class="tok-nx">cancelResolver</span><span class="tok-p">;</span>

<span class="tok-c1">// A simple &quot;constant&quot; value, used to resolved cancel</span>
<span class="tok-c1">// promises.</span>
<span class="tok-kd">var</span> <span class="tok-nx">CANCELLED</span> <span class="tok-o">=</span> <span class="tok-p">{};</span>

<span class="tok-c1">// Our UI components.</span>
<span class="tok-kd">var</span> <span class="tok-nx">buttonLoad</span> <span class="tok-o">=</span> <span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">querySelector</span><span class="tok-p">(</span><span class="tok-s1">&#39;button.load&#39;</span><span class="tok-p">),</span>
    <span class="tok-nx">buttonCancel</span> <span class="tok-o">=</span> <span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">querySelector</span><span class="tok-p">(</span><span class="tok-s1">&#39;button.cancel&#39;</span><span class="tok-p">);</span>

<span class="tok-c1">// Requests data, returns a promise.</span>
<span class="tok-kd">function</span> <span class="tok-nx">getDataPromise</span><span class="tok-p">()</span> <span class="tok-p">{</span>

    <span class="tok-c1">// Creates the cancel promise. The executor assigns</span>
    <span class="tok-c1">// the &quot;resolve&quot; function to &quot;cancelResolver&quot;, so</span>
    <span class="tok-c1">// it can be called later.</span>
    <span class="tok-kd">var</span> <span class="tok-nx">cancelPromise</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nb">Promise</span><span class="tok-p">((</span><span class="tok-nx">resolve</span><span class="tok-p">)</span> <span class="tok-p">=&gt;</span> <span class="tok-p">{</span>
        <span class="tok-nx">cancelResolver</span> <span class="tok-o">=</span> <span class="tok-nx">resolve</span><span class="tok-p">;</span>
    <span class="tok-p">});</span>

    <span class="tok-c1">// The actual data we want. This would normally be</span>
    <span class="tok-c1">// an HTTP request, but we&#39;re simulating one here</span>
    <span class="tok-c1">// for brevity using setTimeout().</span>
    <span class="tok-kd">var</span> <span class="tok-nx">dataPromise</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nb">Promise</span><span class="tok-p">((</span><span class="tok-nx">resolve</span><span class="tok-p">)</span> <span class="tok-p">=&gt;</span> <span class="tok-p">{</span>
        <span class="tok-nx">setTimeout</span><span class="tok-p">(()</span> <span class="tok-p">=&gt;</span> <span class="tok-p">{</span>
            <span class="tok-nx">resolve</span><span class="tok-p">({</span> <span class="tok-nx">hello</span><span class="tok-o">:</span> <span class="tok-s1">&#39;world&#39;</span> <span class="tok-p">});</span>
        <span class="tok-p">},</span> <span class="tok-mi">3000</span><span class="tok-p">);</span>
    <span class="tok-p">});</span>

    <span class="tok-c1">// The &quot;Promise.race()&quot; method returns a new promise,</span>
    <span class="tok-c1">// and it&#39;s resolved with whichever input promise is</span>
    <span class="tok-c1">// resolved first.</span>
    <span class="tok-k">return</span> <span class="tok-nb">Promise</span><span class="tok-p">.</span><span class="tok-nx">race</span><span class="tok-p">([</span>
        <span class="tok-nx">cancelPromise</span><span class="tok-p">,</span>
        <span class="tok-nx">dataPromise</span>
    <span class="tok-p">]);</span>
<span class="tok-p">}</span>

<span class="tok-c1">// When the cancel button is clicked, we use the</span>
<span class="tok-c1">// &quot;cancelResolver()&quot; function to resolve the</span>
<span class="tok-c1">// cancel promise.</span>
<span class="tok-nx">buttonCancel</span><span class="tok-p">.</span><span class="tok-nx">addEventListener</span><span class="tok-p">(</span><span class="tok-s1">&#39;click&#39;</span><span class="tok-p">,</span> <span class="tok-p">()</span> <span class="tok-p">=&gt;</span> <span class="tok-p">{</span>
    <span class="tok-nx">cancelResolver</span><span class="tok-p">(</span><span class="tok-nx">CANCELLED</span><span class="tok-p">);</span>
<span class="tok-p">});</span>

<span class="tok-c1">// When the load button is clicked, we make a request</span>
<span class="tok-c1">// for data using &quot;getDataPromise()&quot;.</span>
<span class="tok-nx">buttonLoad</span><span class="tok-p">.</span><span class="tok-nx">addEventListener</span><span class="tok-p">(</span><span class="tok-s1">&#39;click&#39;</span><span class="tok-p">,</span> <span class="tok-p">()</span> <span class="tok-p">=&gt;</span> <span class="tok-p">{</span>
    <span class="tok-nx">buttonLoad</span><span class="tok-p">.</span><span class="tok-nx">disabled</span> <span class="tok-o">=</span> <span class="tok-kc">true</span><span class="tok-p">;</span>

    <span class="tok-nx">getDataPromise</span><span class="tok-p">().</span><span class="tok-nx">then</span><span class="tok-p">((</span><span class="tok-nx">value</span><span class="tok-p">)</span> <span class="tok-p">=&gt;</span> <span class="tok-p">{</span>
        <span class="tok-nx">buttonLoad</span><span class="tok-p">.</span><span class="tok-nx">disabled</span> <span class="tok-o">=</span> <span class="tok-kc">false</span><span class="tok-p">;</span>

        <span class="tok-c1">// The promise was resolved, but it was because</span>
        <span class="tok-c1">// the user cancelled the request. So we exit</span>
        <span class="tok-c1">// here by returning the CANCELLED &quot;constant&quot;.</span>
        <span class="tok-c1">// Otherwise, we have data to work with.</span>
        <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-nb">Object</span><span class="tok-p">.</span><span class="tok-nx">is</span><span class="tok-p">(</span><span class="tok-nx">value</span><span class="tok-p">,</span> <span class="tok-nx">CANCELLED</span><span class="tok-p">))</span> <span class="tok-p">{</span>
            <span class="tok-k">return</span> <span class="tok-nx">value</span><span class="tok-p">;</span>
        <span class="tok-p">}</span>

        <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s1">&#39;loaded data&#39;</span><span class="tok-p">,</span> <span class="tok-nx">value</span><span class="tok-p">);</span>
    <span class="tok-p">});</span>
<span class="tok-p">});</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_promises_without_executors">Promises without executors</h3>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js"><span class="tok-c1">// Example function that returns &quot;value&quot; from</span>
<span class="tok-c1">// a cache, or &quot;fetchs&quot; it asynchronously.</span>
<span class="tok-kd">function</span> <span class="tok-nx">getData</span><span class="tok-p">(</span><span class="tok-nx">value</span><span class="tok-p">)</span> <span class="tok-p">{</span>

    <span class="tok-c1">// If it exists in the cache, we return</span>
    <span class="tok-c1">// this value.</span>
    <span class="tok-kd">var</span> <span class="tok-nx">index</span> <span class="tok-o">=</span> <span class="tok-nx">getData</span><span class="tok-p">.</span><span class="tok-nx">cache</span><span class="tok-p">.</span><span class="tok-nx">indexOf</span><span class="tok-p">(</span><span class="tok-nx">value</span><span class="tok-p">);</span>
    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-nx">index</span> <span class="tok-o">&gt;</span> <span class="tok-o">-</span><span class="tok-mi">1</span><span class="tok-p">)</span> <span class="tok-p">{</span>
        <span class="tok-k">return</span> <span class="tok-nx">getData</span><span class="tok-p">.</span><span class="tok-nx">cache</span><span class="tok-p">[</span><span class="tok-nx">index</span><span class="tok-p">];</span>
    <span class="tok-p">}</span>

    <span class="tok-c1">// Otherwise, we have to go &quot;fetch&quot; it. This</span>
    <span class="tok-c1">// &quot;resolve()&quot; call would typically be found in</span>
    <span class="tok-c1">// a network request callback function.</span>
    <span class="tok-k">return</span> <span class="tok-k">new</span> <span class="tok-nb">Promise</span><span class="tok-p">((</span><span class="tok-nx">resolve</span><span class="tok-p">)</span> <span class="tok-p">=&gt;</span> <span class="tok-p">{</span>
        <span class="tok-nx">getData</span><span class="tok-p">.</span><span class="tok-nx">cache</span><span class="tok-p">.</span><span class="tok-nx">push</span><span class="tok-p">(</span><span class="tok-nx">value</span><span class="tok-p">);</span>
        <span class="tok-nx">resolve</span><span class="tok-p">(</span><span class="tok-nx">value</span><span class="tok-p">);</span>
    <span class="tok-p">});</span>
<span class="tok-p">}</span>

<span class="tok-c1">// Creates the cache.</span>
<span class="tok-nx">getData</span><span class="tok-p">.</span><span class="tok-nx">cache</span> <span class="tok-o">=</span> <span class="tok-p">[];</span>
<span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s1">&#39;getting foo&#39;</span><span class="tok-p">,</span> <span class="tok-nx">getData</span><span class="tok-p">(</span><span class="tok-s1">&#39;foo&#39;</span><span class="tok-p">));</span>
<span class="tok-c1">// → getting foo Promise</span>
<span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s1">&#39;getting bar&#39;</span><span class="tok-p">,</span> <span class="tok-nx">getData</span><span class="tok-p">(</span><span class="tok-s1">&#39;bar&#39;</span><span class="tok-p">));</span>
<span class="tok-c1">// → getting bar Promise</span>
<span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s1">&#39;getting foo&#39;</span><span class="tok-p">,</span> <span class="tok-nx">getData</span><span class="tok-p">(</span><span class="tok-s1">&#39;foo&#39;</span><span class="tok-p">));</span>
<span class="tok-c1">// → getting foo foo</span></code></pre>
</div>
</div>
<hr>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js"><span class="tok-c1">// Example function that returns &quot;value&quot; from</span>
<span class="tok-c1">// a cache, or &quot;fetchs&quot; it asynchronously.</span>
<span class="tok-kd">function</span> <span class="tok-nx">getData</span><span class="tok-p">(</span><span class="tok-nx">value</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-kd">var</span> <span class="tok-nx">cache</span> <span class="tok-o">=</span> <span class="tok-nx">getData</span><span class="tok-p">.</span><span class="tok-nx">cache</span><span class="tok-p">;</span>

    <span class="tok-c1">// If there&#39;s no cache for this function, let&#39;s</span>
    <span class="tok-c1">// reject the promise. Gotta have cache.</span>
    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-nb">Array</span><span class="tok-p">.</span><span class="tok-nx">isArray</span><span class="tok-p">(</span><span class="tok-nx">cache</span><span class="tok-p">))</span> <span class="tok-p">{</span>
        <span class="tok-k">return</span> <span class="tok-nb">Promise</span><span class="tok-p">.</span><span class="tok-nx">reject</span><span class="tok-p">(</span><span class="tok-s1">&#39;missing cache&#39;</span><span class="tok-p">);</span>
    <span class="tok-p">}</span>

    <span class="tok-c1">// If it exists in the cache, we return</span>
    <span class="tok-c1">// a promise that&#39;s resolved using the</span>
    <span class="tok-c1">// cached value.</span>
    <span class="tok-kd">var</span> <span class="tok-nx">index</span> <span class="tok-o">=</span> <span class="tok-nx">getData</span><span class="tok-p">.</span><span class="tok-nx">cache</span><span class="tok-p">.</span><span class="tok-nx">indexOf</span><span class="tok-p">(</span><span class="tok-nx">value</span><span class="tok-p">);</span>

    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-nx">index</span> <span class="tok-o">&gt;</span> <span class="tok-o">-</span><span class="tok-mi">1</span><span class="tok-p">)</span> <span class="tok-p">{</span>
        <span class="tok-k">return</span> <span class="tok-nb">Promise</span><span class="tok-p">.</span><span class="tok-nx">resolve</span><span class="tok-p">(</span><span class="tok-nx">getData</span><span class="tok-p">.</span><span class="tok-nx">cache</span><span class="tok-p">[</span><span class="tok-nx">index</span><span class="tok-p">]);</span>
    <span class="tok-p">}</span>

    <span class="tok-c1">// Otherwise, we have to go &quot;fetch&quot; it. This</span>
    <span class="tok-c1">// &quot;resolve()&quot; call would typically be found in</span>
    <span class="tok-c1">// a network request callback function.</span>
    <span class="tok-k">return</span> <span class="tok-k">new</span> <span class="tok-nb">Promise</span><span class="tok-p">((</span><span class="tok-nx">resolve</span><span class="tok-p">)</span> <span class="tok-p">=&gt;</span> <span class="tok-p">{</span>
        <span class="tok-nx">getData</span><span class="tok-p">.</span><span class="tok-nx">cache</span><span class="tok-p">.</span><span class="tok-nx">push</span><span class="tok-p">(</span><span class="tok-nx">value</span><span class="tok-p">);</span>
        <span class="tok-nx">resolve</span><span class="tok-p">(</span><span class="tok-nx">value</span><span class="tok-p">);</span>
    <span class="tok-p">});</span>
<span class="tok-p">}</span>

<span class="tok-c1">// Creates the cache.</span>
<span class="tok-nx">getData</span><span class="tok-p">.</span><span class="tok-nx">cache</span> <span class="tok-o">=</span> <span class="tok-p">[];</span>

<span class="tok-c1">// Each call to &quot;getData()&quot; is consistent. Even</span>
<span class="tok-c1">// when synchronous values are used, they still</span>
<span class="tok-c1">// get resolved as promises.</span>
<span class="tok-nx">getData</span><span class="tok-p">(</span><span class="tok-s1">&#39;foo&#39;</span><span class="tok-p">).</span><span class="tok-nx">then</span><span class="tok-p">((</span><span class="tok-nx">value</span><span class="tok-p">)</span> <span class="tok-p">=&gt;</span> <span class="tok-p">{</span>
    <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s1">&#39;getting foo&#39;</span><span class="tok-p">,</span> <span class="tok-sb">`&quot;</span><span class="tok-si">${</span><span class="tok-nx">value</span><span class="tok-si">}</span><span class="tok-sb">&quot;`</span><span class="tok-p">);</span>
<span class="tok-p">},</span> <span class="tok-p">(</span><span class="tok-nx">reason</span><span class="tok-p">)</span> <span class="tok-p">=&gt;</span> <span class="tok-p">{</span>
    <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">error</span><span class="tok-p">(</span><span class="tok-nx">reason</span><span class="tok-p">);</span>
<span class="tok-p">});</span>

<span class="tok-nx">getData</span><span class="tok-p">(</span><span class="tok-s1">&#39;bar&#39;</span><span class="tok-p">).</span><span class="tok-nx">then</span><span class="tok-p">((</span><span class="tok-nx">value</span><span class="tok-p">)</span> <span class="tok-p">=&gt;</span> <span class="tok-p">{</span>
    <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s1">&#39;getting bar&#39;</span><span class="tok-p">,</span> <span class="tok-sb">`&quot;</span><span class="tok-si">${</span><span class="tok-nx">value</span><span class="tok-si">}</span><span class="tok-sb">&quot;`</span><span class="tok-p">);</span>
<span class="tok-p">},</span> <span class="tok-p">(</span><span class="tok-nx">reason</span><span class="tok-p">)</span> <span class="tok-p">=&gt;</span> <span class="tok-p">{</span>
    <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">error</span><span class="tok-p">(</span><span class="tok-nx">reason</span><span class="tok-p">);</span>
<span class="tok-p">});</span>

<span class="tok-nx">getData</span><span class="tok-p">(</span><span class="tok-s1">&#39;foo&#39;</span><span class="tok-p">).</span><span class="tok-nx">then</span><span class="tok-p">((</span><span class="tok-nx">value</span><span class="tok-p">)</span> <span class="tok-p">=&gt;</span> <span class="tok-p">{</span>
    <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s1">&#39;getting foo&#39;</span><span class="tok-p">,</span> <span class="tok-sb">`&quot;</span><span class="tok-si">${</span><span class="tok-nx">value</span><span class="tok-si">}</span><span class="tok-sb">&quot;`</span><span class="tok-p">);</span>
<span class="tok-p">},</span> <span class="tok-p">(</span><span class="tok-nx">reason</span><span class="tok-p">)</span> <span class="tok-p">=&gt;</span> <span class="tok-p">{</span>
    <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">error</span><span class="tok-p">(</span><span class="tok-nx">reason</span><span class="tok-p">);</span>
<span class="tok-p">});</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_4_lazy_evaluation_with_generators">4. Lazy Evaluation with Generators</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_creating_generators_and_yielding_values">Creating generators and yielding values</h3>
<div class="sect3">
<h4 id="_generator_function_syntax">Generator function syntax</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js"><span class="tok-c1">// Generator functions use an asterisk to</span>
<span class="tok-c1">// denote a that a generator instance is returned.</span>
<span class="tok-c1">// We can return values from generators, but instead</span>
<span class="tok-c1">// of the caller getting that value, they&#39;ll always</span>
<span class="tok-c1">// get a generator instance.</span>
<span class="tok-kd">function</span><span class="tok-o">*</span> <span class="tok-nx">gen</span><span class="tok-p">()</span> <span class="tok-p">{</span>
    <span class="tok-k">return</span> <span class="tok-s1">&#39;hello world&#39;</span><span class="tok-p">;</span>
<span class="tok-p">}</span>

<span class="tok-c1">// Creates the generator instance.</span>
<span class="tok-kd">var</span> <span class="tok-nx">generator</span> <span class="tok-o">=</span> <span class="tok-nx">gen</span><span class="tok-p">();</span>

<span class="tok-c1">// Let&#39;s see what this looks like.</span>
<span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s1">&#39;generator&#39;</span><span class="tok-p">,</span> <span class="tok-nx">generator</span><span class="tok-p">);</span>
<span class="tok-c1">// → generator Generator</span>

<span class="tok-c1">// Here&#39;s how we get the return value. Looks awkward,</span>
<span class="tok-c1">// because we would never use a generator function</span>
<span class="tok-c1">// that simply returns a single value.</span>
<span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s1">&#39;return&#39;</span><span class="tok-p">,</span> <span class="tok-nx">generator</span><span class="tok-p">.</span><span class="tok-nx">next</span><span class="tok-p">().</span><span class="tok-nx">value</span><span class="tok-p">);</span>
<span class="tok-c1">// → return hello world</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_yielding_values">Yielding values</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js"><span class="tok-c1">// This function yields values, in order. There&#39;s no</span>
<span class="tok-c1">// container structure, like an array. Instead, each time</span>
<span class="tok-c1">// the yield statement is called, control is yielded</span>
<span class="tok-c1">// back to the caller, and the position in the function</span>
<span class="tok-c1">// is bookmarked.</span>
<span class="tok-kd">function</span><span class="tok-o">*</span> <span class="tok-nx">gen</span><span class="tok-p">()</span> <span class="tok-p">{</span>
    <span class="tok-k">yield</span> <span class="tok-s1">&#39;first&#39;</span><span class="tok-p">;</span>
    <span class="tok-k">yield</span> <span class="tok-s1">&#39;second&#39;</span><span class="tok-p">;</span>
    <span class="tok-k">yield</span> <span class="tok-s1">&#39;third&#39;</span><span class="tok-p">;</span>
<span class="tok-p">}</span>

<span class="tok-kd">var</span> <span class="tok-nx">generator</span> <span class="tok-o">=</span> <span class="tok-nx">gen</span><span class="tok-p">();</span>

<span class="tok-c1">// Each time we call &quot;next()&quot;, control is passed back</span>
<span class="tok-c1">// to the generator function&#39;s execution context. Then,</span>
<span class="tok-c1">// the generator looks up the bookmark for where it</span>
<span class="tok-c1">// last yielded control.</span>
<span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-nx">generator</span><span class="tok-p">.</span><span class="tok-nx">next</span><span class="tok-p">().</span><span class="tok-nx">value</span><span class="tok-p">);</span>
<span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-nx">generator</span><span class="tok-p">.</span><span class="tok-nx">next</span><span class="tok-p">().</span><span class="tok-nx">value</span><span class="tok-p">);</span>
<span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-nx">generator</span><span class="tok-p">.</span><span class="tok-nx">next</span><span class="tok-p">().</span><span class="tok-nx">value</span><span class="tok-p">);</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_iterating_over_generators">Iterating over generators</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js"><span class="tok-c1">// A basic generator function that yields</span>
<span class="tok-c1">// sequential values.</span>
<span class="tok-kd">function</span><span class="tok-o">*</span> <span class="tok-nx">gen</span><span class="tok-p">()</span> <span class="tok-p">{</span>
    <span class="tok-k">yield</span> <span class="tok-s1">&#39;first&#39;</span><span class="tok-p">;</span>
    <span class="tok-k">yield</span> <span class="tok-s1">&#39;second&#39;</span><span class="tok-p">;</span>
    <span class="tok-k">yield</span> <span class="tok-s1">&#39;third&#39;</span><span class="tok-p">;</span>
<span class="tok-p">}</span>

<span class="tok-c1">// Creates the generator.</span>
<span class="tok-kd">var</span> <span class="tok-nx">generator</span> <span class="tok-o">=</span> <span class="tok-nx">gen</span><span class="tok-p">();</span>

<span class="tok-c1">// Loop till the sequence is finished.</span>
<span class="tok-k">while</span><span class="tok-p">(</span><span class="tok-kc">true</span><span class="tok-p">)</span> <span class="tok-p">{</span>

    <span class="tok-c1">// Gets the next item from the sequence.</span>
    <span class="tok-kd">let</span> <span class="tok-nx">item</span> <span class="tok-o">=</span> <span class="tok-nx">generator</span><span class="tok-p">.</span><span class="tok-nx">next</span><span class="tok-p">();</span>

    <span class="tok-c1">// Is there a next value, or are we done?</span>
    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-nx">item</span><span class="tok-p">.</span><span class="tok-nx">done</span><span class="tok-p">)</span> <span class="tok-p">{</span>
        <span class="tok-k">break</span><span class="tok-p">;</span>
    <span class="tok-p">}</span>

    <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s1">&#39;while&#39;</span><span class="tok-p">,</span> <span class="tok-nx">item</span><span class="tok-p">.</span><span class="tok-nx">value</span><span class="tok-p">);</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<hr>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js"><span class="tok-c1">// The &quot;for..of&quot; loop removes the need to explicitly</span>
<span class="tok-c1">// call generator constructs, like &quot;next()&quot;, &quot;value&quot;,</span>
<span class="tok-c1">// and &quot;done&quot;.</span>
<span class="tok-k">for</span> <span class="tok-p">(</span><span class="tok-kd">let</span> <span class="tok-nx">item</span> <span class="tok-k">of</span> <span class="tok-nx">generator</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s1">&#39;for..of&#39;</span><span class="tok-p">,</span> <span class="tok-nx">item</span><span class="tok-p">);</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_infinite_sequences">Infinite sequences</h3>
<div class="sect3">
<h4 id="_no_end_in_sight">No end in sight</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js"><span class="tok-c1">// Generates an infinite Fibonacci sequence.</span>
<span class="tok-kd">function</span><span class="tok-o">*</span> <span class="tok-nx">fib</span><span class="tok-p">()</span> <span class="tok-p">{</span>
    <span class="tok-kd">var</span> <span class="tok-nx">seq</span> <span class="tok-o">=</span> <span class="tok-p">[</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-mi">1</span> <span class="tok-p">],</span>
        <span class="tok-nx">next</span><span class="tok-p">;</span>

    <span class="tok-c1">// This loop doesn&#39;t actually run infinitely,</span>
    <span class="tok-c1">// only as long as items from the sequence</span>
    <span class="tok-c1">// are requested using &quot;next()&quot;.</span>
    <span class="tok-k">while</span> <span class="tok-p">(</span><span class="tok-kc">true</span><span class="tok-p">)</span> <span class="tok-p">{</span>

        <span class="tok-c1">// Yields the next item in the sequence.</span>
        <span class="tok-k">yield</span> <span class="tok-p">(</span><span class="tok-nx">next</span> <span class="tok-o">=</span> <span class="tok-nx">seq</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">]</span> <span class="tok-o">+</span> <span class="tok-nx">seq</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">]);</span>

        <span class="tok-c1">// Stores state necessary to compute the</span>
        <span class="tok-c1">// item in the next iteration.</span>
        <span class="tok-nx">seq</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-nx">seq</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">];</span>
        <span class="tok-nx">seq</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-nx">next</span><span class="tok-p">;</span>
    <span class="tok-p">}</span>
<span class="tok-p">}</span>

<span class="tok-c1">// Launch the generator. This will never be &quot;done&quot;</span>
<span class="tok-c1">// generating values. However, it&#39;s lazy - it only</span>
<span class="tok-c1">// generates what we ask for.</span>
<span class="tok-kd">var</span> <span class="tok-nx">generator</span> <span class="tok-o">=</span> <span class="tok-nx">fib</span><span class="tok-p">();</span>

<span class="tok-c1">// Gets the first 5 items of the sequence.</span>
<span class="tok-k">for</span> <span class="tok-p">(</span><span class="tok-kd">let</span> <span class="tok-nx">i</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span> <span class="tok-nx">i</span> <span class="tok-o">&lt;</span> <span class="tok-mi">5</span><span class="tok-p">;</span> <span class="tok-nx">i</span><span class="tok-o">++</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s1">&#39;item&#39;</span><span class="tok-p">,</span> <span class="tok-nx">generator</span><span class="tok-p">.</span><span class="tok-nx">next</span><span class="tok-p">().</span><span class="tok-nx">value</span><span class="tok-p">);</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_alternating_sequences">Alternating sequences</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js"><span class="tok-c1">// A generic generator that will infinitely iterate</span>
<span class="tok-c1">// over the provided arguments, yielding each item.</span>
<span class="tok-kd">function</span><span class="tok-o">*</span> <span class="tok-nx">alternate</span><span class="tok-p">(...</span><span class="tok-nx">seq</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-k">while</span> <span class="tok-p">(</span><span class="tok-kc">true</span><span class="tok-p">)</span> <span class="tok-p">{</span>
        <span class="tok-k">for</span> <span class="tok-p">(</span><span class="tok-kd">let</span> <span class="tok-nx">item</span> <span class="tok-k">of</span> <span class="tok-nx">seq</span><span class="tok-p">)</span> <span class="tok-p">{</span>
            <span class="tok-k">yield</span> <span class="tok-nx">item</span><span class="tok-p">;</span>
        <span class="tok-p">}</span>
    <span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<hr>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js"><span class="tok-c1">// Create a generator that alternates between</span>
<span class="tok-c1">// the provided arguments.</span>
<span class="tok-kd">var</span> <span class="tok-nx">alternator</span> <span class="tok-o">=</span> <span class="tok-nx">alternate</span><span class="tok-p">(</span><span class="tok-kc">true</span><span class="tok-p">,</span> <span class="tok-kc">false</span><span class="tok-p">);</span>

<span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s1">&#39;true/false&#39;</span><span class="tok-p">,</span> <span class="tok-nx">alternator</span><span class="tok-p">.</span><span class="tok-nx">next</span><span class="tok-p">().</span><span class="tok-nx">value</span><span class="tok-p">);</span>
<span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s1">&#39;true/false&#39;</span><span class="tok-p">,</span> <span class="tok-nx">alternator</span><span class="tok-p">.</span><span class="tok-nx">next</span><span class="tok-p">().</span><span class="tok-nx">value</span><span class="tok-p">);</span>
<span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s1">&#39;true/false&#39;</span><span class="tok-p">,</span> <span class="tok-nx">alternator</span><span class="tok-p">.</span><span class="tok-nx">next</span><span class="tok-p">().</span><span class="tok-nx">value</span><span class="tok-p">);</span>
<span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s1">&#39;true/false&#39;</span><span class="tok-p">,</span> <span class="tok-nx">alternator</span><span class="tok-p">.</span><span class="tok-nx">next</span><span class="tok-p">().</span><span class="tok-nx">value</span><span class="tok-p">);</span>
<span class="tok-c1">// →</span>
<span class="tok-c1">// true/false true</span>
<span class="tok-c1">// true/false false</span>
<span class="tok-c1">// true/false true</span>
<span class="tok-c1">// true/false false</span></code></pre>
</div>
</div>
<hr>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js"><span class="tok-c1">// Create a new generator instance, with new values</span>
<span class="tok-c1">// to alternate with each iteration.</span>
<span class="tok-nx">alternator</span> <span class="tok-o">=</span> <span class="tok-nx">alternate</span><span class="tok-p">(</span><span class="tok-s1">&#39;one&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;two&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;three&#39;</span><span class="tok-p">);</span>

<span class="tok-c1">// Gets the first 10 items from the infinite sequence.</span>
<span class="tok-k">for</span> <span class="tok-p">(</span><span class="tok-kd">let</span> <span class="tok-nx">i</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span> <span class="tok-nx">i</span><span class="tok-o">&lt;</span> <span class="tok-mi">10</span><span class="tok-p">;</span> <span class="tok-nx">i</span><span class="tok-o">++</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s1">&#39;one/two/three&#39;</span><span class="tok-p">,</span>
        <span class="tok-sb">`&quot;</span><span class="tok-si">${</span><span class="tok-nx">alternator</span><span class="tok-p">.</span><span class="tok-nx">next</span><span class="tok-p">().</span><span class="tok-nx">value</span><span class="tok-si">}</span><span class="tok-sb">&quot;`</span><span class="tok-p">);</span>
<span class="tok-p">}</span>

<span class="tok-c1">// →</span>
<span class="tok-c1">// one/two/three &quot;one&quot;</span>
<span class="tok-c1">// one/two/three &quot;two&quot;</span>
<span class="tok-c1">// one/two/three &quot;three&quot;</span>
<span class="tok-c1">// one/two/three &quot;one&quot;</span>
<span class="tok-c1">// one/two/three &quot;two&quot;</span>
<span class="tok-c1">// one/two/three &quot;three&quot;</span>
<span class="tok-c1">// one/two/three &quot;one&quot;</span>
<span class="tok-c1">// one/two/three &quot;two&quot;</span>
<span class="tok-c1">// one/two/three &quot;three&quot;</span>
<span class="tok-c1">// one/two/three &quot;one&quot;</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_9_advanced_nodejs_concurrency">9. Advanced NodeJS Concurrency</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_coroutines_with_co">Coroutines with Co</h3>
<div class="sect3">
<h4 id="_awaiting_values">Awaiting values</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js"><span class="tok-c1">// This is the ES7 syntax, where the function is</span>
<span class="tok-c1">// marked as &quot;async&quot;. Then, the &quot;await&quot; calls</span>
<span class="tok-c1">// pause execution till their operands resolve.</span>
<span class="tok-p">(</span><span class="tok-nx">async</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
    <span class="tok-kd">var</span> <span class="tok-nx">result</span><span class="tok-p">;</span>
    <span class="tok-nx">result</span> <span class="tok-o">=</span> <span class="tok-nx">await</span> <span class="tok-nb">Promise</span><span class="tok-p">.</span><span class="tok-nx">resolve</span><span class="tok-p">(</span><span class="tok-s1">&#39;hello&#39;</span><span class="tok-p">);</span>
    <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s1">&#39;async result&#39;</span><span class="tok-p">,</span> <span class="tok-sb">`&quot;</span><span class="tok-si">${</span><span class="tok-nx">result</span><span class="tok-si">}</span><span class="tok-sb">&quot;`</span><span class="tok-p">);</span>
    <span class="tok-c1">// → async result &quot;hello&quot;</span>

    <span class="tok-nx">result</span> <span class="tok-o">=</span> <span class="tok-nx">await</span> <span class="tok-nb">Promise</span><span class="tok-p">.</span><span class="tok-nx">resolve</span><span class="tok-p">(</span><span class="tok-s1">&#39;world&#39;</span><span class="tok-p">);</span>
    <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s1">&#39;async result&#39;</span><span class="tok-p">,</span> <span class="tok-sb">`&quot;</span><span class="tok-si">${</span><span class="tok-nx">result</span><span class="tok-si">}</span><span class="tok-sb">&quot;`</span><span class="tok-p">);</span>
    <span class="tok-c1">// → async result &quot;world&quot;</span>
<span class="tok-p">}());</span></code></pre>
</div>
</div>
<hr>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js"><span class="tok-c1">// We need the &quot;co()&quot; function.</span>
<span class="tok-kd">var</span> <span class="tok-nx">co</span> <span class="tok-o">=</span> <span class="tok-nx">require</span><span class="tok-p">(</span><span class="tok-s1">&#39;co&#39;</span><span class="tok-p">);</span>

<span class="tok-c1">// The differences between the ES7 and &quot;co()&quot; are</span>
<span class="tok-c1">// subtle, the overall structure is the same. The</span>
<span class="tok-c1">// function is a generator, and we pause execution</span>
<span class="tok-c1">// by yielding generators.</span>
<span class="tok-nx">co</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-o">*</span><span class="tok-p">()</span> <span class="tok-p">{</span>
    <span class="tok-kd">var</span> <span class="tok-nx">result</span><span class="tok-p">;</span>
    <span class="tok-nx">result</span> <span class="tok-o">=</span> <span class="tok-k">yield</span> <span class="tok-nb">Promise</span><span class="tok-p">.</span><span class="tok-nx">resolve</span><span class="tok-p">(</span><span class="tok-s1">&#39;hello&#39;</span><span class="tok-p">);</span>
    <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s1">&#39;co result&#39;</span><span class="tok-p">,</span> <span class="tok-sb">`&quot;</span><span class="tok-si">${</span><span class="tok-nx">result</span><span class="tok-si">}</span><span class="tok-sb">&quot;`</span><span class="tok-p">);</span>
    <span class="tok-c1">// → co result &quot;hello&quot;</span>

    <span class="tok-nx">result</span> <span class="tok-o">=</span> <span class="tok-k">yield</span> <span class="tok-nb">Promise</span><span class="tok-p">.</span><span class="tok-nx">resolve</span><span class="tok-p">(</span><span class="tok-s1">&#39;world&#39;</span><span class="tok-p">);</span>
    <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s1">&#39;co result&#39;</span><span class="tok-p">,</span> <span class="tok-sb">`&quot;</span><span class="tok-si">${</span><span class="tok-nx">result</span><span class="tok-si">}</span><span class="tok-sb">&quot;`</span><span class="tok-p">);</span>
    <span class="tok-c1">// → co result &quot;world&quot;</span>
<span class="tok-p">});</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2019-05-10 23:34:04 +03
</div>
</div>
</body>
</html>